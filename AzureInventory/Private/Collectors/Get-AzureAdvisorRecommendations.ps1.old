<#
.SYNOPSIS
    Collects Azure Advisor recommendations for a subscription.

.DESCRIPTION
    Retrieves all Azure Advisor recommendations across categories:
    - Cost: Cost optimization recommendations
    - Security: Security recommendations
    - Reliability: High availability recommendations
    - OperationalExcellence: Operational best practices
    - Performance: Performance optimization recommendations

.PARAMETER SubscriptionId
    Azure subscription ID to scan.

.PARAMETER SubscriptionName
    Human-readable subscription name.

.OUTPUTS
    Array of recommendation objects.
#>
function Get-AzureAdvisorRecommendations {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory = $true)]
        [string]$SubscriptionId,
        
        [Parameter(Mandatory = $true)]
        [string]$SubscriptionName
    )
    
    $recommendations = [System.Collections.Generic.List[PSObject]]::new()
    
    try {
        # Check if Az.Advisor module is available
        if (-not (Get-Module -ListAvailable -Name Az.Advisor)) {
            Write-Warning "Az.Advisor module is not installed. Install it with: Install-Module -Name Az.Advisor"
            return $recommendations
        }
        
        # Import module if not already imported
        if (-not (Get-Module -Name Az.Advisor)) {
            Import-Module Az.Advisor -ErrorAction SilentlyContinue
        }
        
        # Check if cmdlet exists
        if (-not (Get-Command -Name Get-AzAdvisorRecommendation -ErrorAction SilentlyContinue)) {
            Write-Warning "Get-AzAdvisorRecommendation cmdlet not found. Advisor recommendations cannot be retrieved."
            return $recommendations
        }
        
        Write-Host "    [DEBUG] Retrieving Advisor recommendations for subscription $SubscriptionName ($SubscriptionId)..." -ForegroundColor Yellow
        
        # Verify we're in the correct subscription context
        $currentContext = Get-AzContext
        Write-Host "    [DEBUG] Current subscription context: $($currentContext.Subscription.Id)" -ForegroundColor Yellow
        if ($currentContext.Subscription.Id -ne $SubscriptionId) {
            Write-Host "    [DEBUG] WARNING: Current subscription context does not match target!" -ForegroundColor Red
        }
        
        # Get all Advisor recommendations for the subscription
        # Try with subscription context first
        $advisorRecs = $null
        try {
            Write-Host "    [DEBUG] Attempting to retrieve recommendations using Get-AzAdvisorRecommendation..." -ForegroundColor Yellow
            $advisorRecs = Get-AzAdvisorRecommendation -ErrorAction Stop
            Write-Host "    [DEBUG] Get-AzAdvisorRecommendation returned: $($advisorRecs.Count) recommendations" -ForegroundColor $(if ($advisorRecs.Count -gt 0) { 'Green' } else { 'Yellow' })
            
            # Debug: Show first recommendation structure if available
            if ($advisorRecs -and $advisorRecs.Count -gt 0) {
                Write-Host "    [DEBUG] First recommendation sample:" -ForegroundColor Yellow
                $firstRec = $advisorRecs[0]
                Write-Host "      - Category: $($firstRec.Category)" -ForegroundColor Gray
                Write-Host "      - Impact: $($firstRec.Impact)" -ForegroundColor Gray
                Write-Host "      - ResourceId: $($firstRec.ResourceId)" -ForegroundColor Gray
            }
        }
        catch {
            Write-Host "    [DEBUG] Get-AzAdvisorRecommendation failed: $_" -ForegroundColor Red
            Write-Host "    [DEBUG] Error type: $($_.Exception.GetType().FullName)" -ForegroundColor Red
            Write-Host "    [DEBUG] Error message: $($_.Exception.Message)" -ForegroundColor Red
            
            # Try alternative: Get recommendations via REST API
            Write-Host "    [DEBUG] Attempting to retrieve via REST API..." -ForegroundColor Yellow
            try {
                $uri = "https://management.azure.com/subscriptions/$SubscriptionId/providers/Microsoft.Advisor/recommendations?api-version=2023-01-01"
                Write-Host "    [DEBUG] REST API URI: $uri" -ForegroundColor Yellow
                $response = Invoke-AzRestMethod -Method GET -Uri $uri -ErrorAction Stop
                Write-Host "    [DEBUG] REST API response status: $($response.StatusCode)" -ForegroundColor Yellow
                
                if ($response.Content) {
                    $advisorData = $response.Content | ConvertFrom-Json
                    Write-Host "    [DEBUG] REST API returned $($advisorData.value.Count) recommendations" -ForegroundColor $(if ($advisorData.value.Count -gt 0) { 'Green' } else { 'Yellow' })
                    if ($advisorData.value -and $advisorData.value.Count -gt 0) {
                        $advisorRecs = $advisorData.value
                        Write-Host "    [DEBUG] First REST API recommendation sample:" -ForegroundColor Yellow
                        $firstRec = $advisorData.value[0]
                        Write-Host "      - Category: $($firstRec.properties.category)" -ForegroundColor Gray
                        Write-Host "      - Impact: $($firstRec.properties.impact)" -ForegroundColor Gray
                    }
                } else {
                    Write-Host "    [DEBUG] REST API response has no content" -ForegroundColor Yellow
                }
            }
            catch {
                Write-Host "    [DEBUG] Failed to retrieve Advisor recommendations via REST API: $_" -ForegroundColor Red
                Write-Host "    [DEBUG] REST API error details: $($_.Exception.Message)" -ForegroundColor Red
            }
        }
        
        if (-not $advisorRecs) {
            Write-Host "    [DEBUG] No Advisor recommendations found in subscription $SubscriptionName" -ForegroundColor Yellow
            return $recommendations
        }
        
        # Handle both single object and array
        if ($advisorRecs -isnot [System.Array]) {
            $advisorRecs = @($advisorRecs)
        }
        
        Write-Host "    [DEBUG] Processing $($advisorRecs.Count) Advisor recommendations..." -ForegroundColor Yellow
        
        $processedCount = 0
        $skippedCount = 0
        foreach ($rec in $advisorRecs) {
            try {
                # Debug: Show detailed object structure for first recommendation
                if ($processedCount -eq 0) {
                    Write-Host "    [DEBUG] ===== FIRST RECOMMENDATION DETAILED STRUCTURE =====" -ForegroundColor Cyan
                    Write-Host "    [DEBUG] Top-level properties: $($rec.PSObject.Properties.Name -join ', ')" -ForegroundColor Yellow
                    Write-Host ""
                    
                    # Show key direct properties
                    Write-Host "    [DEBUG] --- Key Direct Properties ---" -ForegroundColor Yellow
                    Write-Host "    [DEBUG] Category: $($rec.Category)" -ForegroundColor Green
                    Write-Host "    [DEBUG] Impact: $($rec.Impact)" -ForegroundColor Green
                    Write-Host "    [DEBUG] ImpactedValue: $($rec.ImpactedValue)" -ForegroundColor Green
                    Write-Host "    [DEBUG] ImpactedField: $($rec.ImpactedField)" -ForegroundColor Green
                    Write-Host "    [DEBUG] ResourceGroupName: $($rec.ResourceGroupName)" -ForegroundColor Green
                    Write-Host "    [DEBUG] ResourceMetadataResourceId: $($rec.ResourceMetadataResourceId)" -ForegroundColor Green
                    Write-Host "    [DEBUG] ShortDescriptionProblem: $($rec.ShortDescriptionProblem)" -ForegroundColor Green
                    Write-Host "    [DEBUG] ShortDescriptionSolution: $($rec.ShortDescriptionSolution)" -ForegroundColor Green
                    Write-Host "    [DEBUG] Description: $($rec.Description)" -ForegroundColor Green
                    Write-Host "    [DEBUG] RecommendationTypeId: $($rec.RecommendationTypeId)" -ForegroundColor Green
                    Write-Host "    [DEBUG] PotentialBenefit: $($rec.PotentialBenefit)" -ForegroundColor Green
                    Write-Host "    [DEBUG] Remediation: $($rec.Remediation)" -ForegroundColor Green
                    Write-Host ""
                    
                    # Show ExtendedProperty if exists
                    if ($rec.ExtendedProperty) {
                        Write-Host "    [DEBUG] --- ExtendedProperty ---" -ForegroundColor Yellow
                        Write-Host "    [DEBUG] ExtendedProperty type: $($rec.ExtendedProperty.GetType().FullName)" -ForegroundColor Yellow
                        if ($rec.ExtendedProperty -is [Hashtable]) {
                            Write-Host "    [DEBUG] ExtendedProperty keys: $($rec.ExtendedProperty.Keys -join ', ')" -ForegroundColor Yellow
                            foreach ($key in $rec.ExtendedProperty.Keys) {
                                Write-Host "    [DEBUG]   $key = $($rec.ExtendedProperty[$key])" -ForegroundColor Gray
                            }
                        } else {
                            Write-Host "    [DEBUG] ExtendedProperty properties: $($rec.ExtendedProperty.PSObject.Properties.Name -join ', ')" -ForegroundColor Yellow
                            foreach ($prop in $rec.ExtendedProperty.PSObject.Properties) {
                                Write-Host "    [DEBUG]   $($prop.Name) = $($prop.Value)" -ForegroundColor Gray
                            }
                        }
                        Write-Host ""
                    }
                    
                    # Show ExtendedProperties (alternative name)
                    if ($rec.ExtendedProperties) {
                        Write-Host "    [DEBUG] --- ExtendedProperties ---" -ForegroundColor Yellow
                        Write-Host "    [DEBUG] ExtendedProperties type: $($rec.ExtendedProperties.GetType().FullName)" -ForegroundColor Yellow
                        Write-Host ""
                    }
                    
                    # Show Metadata if exists
                    if ($rec.Metadata) {
                        Write-Host "    [DEBUG] --- Metadata ---" -ForegroundColor Yellow
                        Write-Host "    [DEBUG] Metadata type: $($rec.Metadata.GetType().FullName)" -ForegroundColor Yellow
                        Write-Host "    [DEBUG] Metadata properties: $($rec.Metadata.PSObject.Properties.Name -join ', ')" -ForegroundColor Yellow
                        if ($rec.Metadata.AdditionalProperties) {
                            Write-Host "    [DEBUG] Metadata.AdditionalProperties type: $($rec.Metadata.AdditionalProperties.GetType().FullName)" -ForegroundColor Yellow
                            if ($rec.Metadata.AdditionalProperties -is [Hashtable] -or $rec.Metadata.AdditionalProperties -is [System.Collections.IDictionary]) {
                                Write-Host "    [DEBUG] Metadata.AdditionalProperties keys: $($rec.Metadata.AdditionalProperties.Keys -join ', ')" -ForegroundColor Yellow
                                if ($rec.Metadata.AdditionalProperties.ContainsKey('annualSavingsAmount')) {
                                    Write-Host "    [DEBUG] Metadata.AdditionalProperties['annualSavingsAmount'] = $($rec.Metadata.AdditionalProperties['annualSavingsAmount']) (type: $($rec.Metadata.AdditionalProperties['annualSavingsAmount'].GetType().FullName))" -ForegroundColor Green
                                }
                            } else {
                                Write-Host "    [DEBUG] Metadata.AdditionalProperties properties: $($rec.Metadata.AdditionalProperties.PSObject.Properties.Name -join ', ')" -ForegroundColor Yellow
                                if ($rec.Metadata.AdditionalProperties.PSObject.Properties['annualSavingsAmount']) {
                                    Write-Host "    [DEBUG] Metadata.AdditionalProperties.annualSavingsAmount = $($rec.Metadata.AdditionalProperties.PSObject.Properties['annualSavingsAmount'].Value) (type: $($rec.Metadata.AdditionalProperties.PSObject.Properties['annualSavingsAmount'].Value.GetType().FullName))" -ForegroundColor Green
                                }
                            }
                        }
                        if ($rec.Metadata.Keys -and $rec.Metadata.Values) {
                            Write-Host "    [DEBUG] Metadata.Keys count: $($rec.Metadata.Keys.Count)" -ForegroundColor Yellow
                            $annualSavingsKeyIndex = -1
                            # Use IndexOf if available (faster), otherwise loop
                            if ($rec.Metadata.Keys -is [System.Collections.IList]) {
                                $annualSavingsKeyIndex = $rec.Metadata.Keys.IndexOf('annualSavingsAmount')
                            } else {
                                # Convert Keys to array if it's a KeyCollection or similar
                                $debugKeysArray = @($rec.Metadata.Keys)
                                for ($i = 0; $i -lt $debugKeysArray.Count; $i++) {
                                    if ($debugKeysArray[$i] -eq 'annualSavingsAmount') {
                                        $annualSavingsKeyIndex = $i
                                        break
                                    }
                                }
                            }
                            if ($annualSavingsKeyIndex -ge 0) {
                                # Convert Values to array if needed
                                $debugValuesArray = @($rec.Metadata.Values)
                                if ($annualSavingsKeyIndex -lt $debugValuesArray.Count) {
                                    Write-Host "    [DEBUG] Metadata.Values[$annualSavingsKeyIndex] (annualSavingsAmount) = $($debugValuesArray[$annualSavingsKeyIndex])" -ForegroundColor Green
                                }
                            }
                        }
                        Write-Host ""
                    }
                    
                    Write-Host "    [DEBUG] ==================================================" -ForegroundColor Cyan
                }
                
                # Handle both PowerShell objects and JSON objects from REST API
                # Note: Get-AzAdvisorRecommendation returns objects with direct properties, not nested in "properties"
                $recId = if ($rec.Id) { $rec.Id } elseif ($rec.id) { $rec.id } else { "Unknown" }
                
                # Get category and map Azure Advisor categories to standard names
                $rawCategory = if ($rec.Category) { $rec.Category } elseif ($rec.properties.category) { $rec.properties.category } else { "Unknown" }
                # Map Azure Advisor categories: HighAvailability -> Reliability
                $recCategory = switch ($rawCategory) {
                    "HighAvailability" { "Reliability" }
                    "OperationalExcellence" { "OperationalExcellence" }
                    default { $rawCategory }
                }
                
                $recImpact = if ($rec.Impact) { $rec.Impact } elseif ($rec.properties.impact) { $rec.properties.impact } else { "Unknown" }
                
                # Get ResourceId - try direct properties first (from Get-AzAdvisorRecommendation)
                $recResourceId = $null
                if ($rec.ResourceMetadataResourceId) {
                    $recResourceId = $rec.ResourceMetadataResourceId
                } elseif ($rec.ResourceId) { 
                    $recResourceId = $rec.ResourceId 
                } elseif ($rec.ResourceMetadata -and $rec.ResourceMetadata.ResourceId) {
                    $recResourceId = $rec.ResourceMetadata.ResourceId
                } elseif ($rec.properties.resourceMetadata -and $rec.properties.resourceMetadata.resourceId) { 
                    $recResourceId = $rec.properties.resourceMetadata.resourceId 
                } elseif ($rec.properties.resourceId) {
                    $recResourceId = $rec.properties.resourceId
                }
                
                $recImpactedValue = if ($rec.ImpactedValue) { $rec.ImpactedValue } elseif ($rec.properties.impactedValue) { $rec.properties.impactedValue } else { $null }
                $recImpactedField = if ($rec.ImpactedField) { $rec.ImpactedField } elseif ($rec.properties.impactedField) { $rec.properties.impactedField } else { "Unknown" }
                
                if ($processedCount -lt 3) {
                    Write-Host "    [DEBUG] Processing recommendation $($processedCount + 1): Category=$recCategory (raw=$rawCategory), Impact=$recImpact, ResourceId=$recResourceId" -ForegroundColor Gray
                }
                
                # Get Problem - try direct properties first (from Get-AzAdvisorRecommendation)
                $problem = $null
                if ($rec.ShortDescriptionProblem) {
                    $problem = $rec.ShortDescriptionProblem.Trim()
                } elseif ($rec.ShortDescription -and $rec.ShortDescription.Problem) {
                    $problem = $rec.ShortDescription.Problem.Trim()
                } elseif ($rec.properties.shortDescription -and $rec.properties.shortDescription.problem) {
                    $problem = $rec.properties.shortDescription.problem.Trim()
                } elseif ($rec.Description) {
                    $problem = $rec.Description.Trim()
                } elseif ($rec.properties.description) {
                    $problem = $rec.properties.description.Trim()
                } else {
                    $recTypeId = if ($rec.RecommendationTypeId) { $rec.RecommendationTypeId } elseif ($rec.properties.recommendationTypeId) { $rec.properties.recommendationTypeId } else { $null }
                    if ($recTypeId) {
                        $problem = "Recommendation Type: $recTypeId"
                    } else {
                        $problem = "See Azure Portal for details"
                    }
                }
                
                # Get Solution - try direct properties first
                $solution = $null
                if ($rec.ShortDescriptionSolution) {
                    $solution = $rec.ShortDescriptionSolution.Trim()
                } elseif ($rec.ShortDescription -and $rec.ShortDescription.Solution) {
                    $solution = $rec.ShortDescription.Solution.Trim()
                } elseif ($rec.properties.shortDescription -and $rec.properties.shortDescription.solution) {
                    $solution = $rec.properties.shortDescription.solution.Trim()
                } elseif ($rec.Remediation) {
                    $solution = $rec.Remediation.Trim()
                } else {
                    $solution = "See Azure Portal for details"
                }
                
                # Parse resource name - ImpactedValue is typically the resource name
                $resourceName = "Unknown"
                if ($recImpactedValue) {
                    $resourceName = $recImpactedValue
                } elseif ($rec.Name) {
                    $resourceName = $rec.Name
                } elseif ($recResourceId -and $recResourceId -match '/') {
                    $resourceName = ($recResourceId -split '/')[-1]
                }
                
                # Parse resource group - use direct property first
                $resourceGroup = "N/A"
                if ($rec.ResourceGroupName) {
                    $resourceGroup = $rec.ResourceGroupName
                } elseif ($recResourceId -and $recResourceId -match '/resourceGroups/([^/]+)/') {
                    $resourceGroup = $Matches[1]
                }
                
                if ($processedCount -lt 3) {
                    Write-Host "    [DEBUG] ResourceName=$resourceName, ImpactedValue=$recImpactedValue, ResourceId=$recResourceId, ResourceGroup=$resourceGroup" -ForegroundColor Gray
                }
                
                # Get potential savings for Cost recommendations
                $potentialSavings = $null
                $savingsCurrency = $null
                
                if ($recCategory -eq 'Cost') {
                    # Try Metadata first (most reliable source for cost savings)
                    $metadata = if ($rec.Metadata) { $rec.Metadata } elseif ($rec.properties.metadata) { $rec.properties.metadata } else { $null }
                    
                    if ($metadata) {
                        if ($processedCount -lt 3) {
                            Write-Host "    [DEBUG] Metadata found! Type: $($metadata.GetType().FullName)" -ForegroundColor Yellow
                            Write-Host "    [DEBUG] Metadata properties: $($metadata.PSObject.Properties.Name -join ', ')" -ForegroundColor Yellow
                            if ($metadata.AdditionalProperties) {
                                Write-Host "    [DEBUG] Metadata.AdditionalProperties type: $($metadata.AdditionalProperties.GetType().FullName)" -ForegroundColor Yellow
                                Write-Host "    [DEBUG] Metadata.AdditionalProperties.annualSavingsAmount: $($metadata.AdditionalProperties.annualSavingsAmount) (type: $($metadata.AdditionalProperties.annualSavingsAmount.GetType().FullName))" -ForegroundColor Yellow
                            }
                            if ($metadata.Keys) {
                                Write-Host "    [DEBUG] Metadata.Keys count: $($metadata.Keys.Count)" -ForegroundColor Yellow
                                $annualSavingsKeyIndex = -1
                                # Use IndexOf if available (faster), otherwise loop
                                if ($metadata.Keys -is [System.Collections.IList]) {
                                    $annualSavingsKeyIndex = $metadata.Keys.IndexOf('annualSavingsAmount')
                                } else {
                                    # Convert Keys to array if it's a KeyCollection or similar
                                    $debugKeysArray = @($metadata.Keys)
                                    for ($i = 0; $i -lt $debugKeysArray.Count; $i++) {
                                        if ($debugKeysArray[$i] -eq 'annualSavingsAmount') {
                                            $annualSavingsKeyIndex = $i
                                            break
                                        }
                                    }
                                }
                                if ($annualSavingsKeyIndex -ge 0) {
                                    # Convert Values to array if needed
                                    $debugValuesArray = @($metadata.Values)
                                    if ($annualSavingsKeyIndex -lt $debugValuesArray.Count) {
                                        Write-Host "    [DEBUG] Found annualSavingsAmount at Keys index $annualSavingsKeyIndex, Values[$annualSavingsKeyIndex] = $($debugValuesArray[$annualSavingsKeyIndex])" -ForegroundColor Yellow
                                    }
                                }
                            }
                        }
                        
                        # Handle Metadata with Keys/Values arrays and AdditionalProperties
                        # Try AdditionalProperties first (most common structure) - use robust extraction
                        if ($metadata.AdditionalProperties) {
                            $additionalProps = $metadata.AdditionalProperties
                            
                            # Robust extraction: Try multiple access methods
                            $savingsValue = $null
                            $currencyValue = $null
                            
                            # Method 1: IDictionary/Hashtable with ContainsKey
                            if ($additionalProps -is [System.Collections.IDictionary]) {
                                try {
                                    if ($additionalProps.ContainsKey('annualSavingsAmount')) {
                                        $savingsValue = $additionalProps['annualSavingsAmount']
                                    }
                                    if ($additionalProps.ContainsKey('savingsCurrency')) {
                                        $currencyValue = $additionalProps['savingsCurrency']
                                    }
                                } catch {
                                    Write-Verbose "Failed to access AdditionalProperties as IDictionary: $_"
                                }
                            }
                            
                            # Method 2: Try direct property access (PSCustomObject)
                            if (-not $savingsValue) {
                                try {
                                    if ($additionalProps.PSObject.Properties['annualSavingsAmount']) {
                                        $savingsValue = $additionalProps.PSObject.Properties['annualSavingsAmount'].Value
                                    } elseif ($additionalProps.annualSavingsAmount) {
                                        $savingsValue = $additionalProps.annualSavingsAmount
                                    }
                                } catch {
                                    Write-Verbose "Failed to access annualSavingsAmount as property: $_"
                                }
                            }
                            
                            if (-not $currencyValue) {
                                try {
                                    if ($additionalProps.PSObject.Properties['savingsCurrency']) {
                                        $currencyValue = $additionalProps.PSObject.Properties['savingsCurrency'].Value
                                    } elseif ($additionalProps.savingsCurrency) {
                                        $currencyValue = $additionalProps.savingsCurrency
                                    }
                                } catch {
                                    Write-Verbose "Failed to access savingsCurrency as property: $_"
                                }
                            }
                            
                            # Method 3: Try GetEnumerator for generic dictionaries
                            if (-not $savingsValue -and $additionalProps -is [System.Collections.IDictionary]) {
                                try {
                                    foreach ($key in $additionalProps.Keys) {
                                        if ($key -eq 'annualSavingsAmount') {
                                            $savingsValue = $additionalProps[$key]
                                        }
                                        if ($key -eq 'savingsCurrency') {
                                            $currencyValue = $additionalProps[$key]
                                        }
                                    }
                                } catch {
                                    Write-Verbose "Failed to enumerate AdditionalProperties: $_"
                                }
                            }
                            
                            # Parse savings value
                            if ($savingsValue) {
                                try {
                                    # Handle both string and numeric values
                                    if ($savingsValue -is [string]) {
                                        $savingsValue = $savingsValue.Trim()
                                        if ($savingsValue -match '^\d+(\.\d+)?$') {
                                            $potentialSavings = [decimal]$savingsValue
                                        }
                                    } else {
                                        $potentialSavings = [decimal]$savingsValue
                                    }
                                    if ($processedCount -lt 3) {
                                        Write-Host "    [DEBUG] Parsed annualSavingsAmount from AdditionalProperties: $potentialSavings (original: $savingsValue)" -ForegroundColor Green
                                    }
                                } catch {
                                    Write-Host "    [DEBUG] Failed to parse annualSavingsAmount: $savingsValue - $_" -ForegroundColor Red
                                }
                            }
                            
                            if ($currencyValue) {
                                $savingsCurrency = $currencyValue.ToString()
                            }
                        }
                        
                        # Also try Keys/Values array structure
                        if (-not $potentialSavings -and $metadata.Keys -and $metadata.Values) {
                            $annualSavingsIndex = -1
                            $currencyIndex = -1
                            
                            # Use IndexOf if available (faster), otherwise loop
                            if ($metadata.Keys -is [System.Collections.IList]) {
                                $annualSavingsIndex = $metadata.Keys.IndexOf('annualSavingsAmount')
                                $currencyIndex = $metadata.Keys.IndexOf('savingsCurrency')
                            } else {
                                # Convert Keys to array if it's a KeyCollection or similar
                                $keysArray = @($metadata.Keys)
                                $valuesArray = @($metadata.Values)
                                for ($i = 0; $i -lt $keysArray.Count; $i++) {
                                    if ($keysArray[$i] -eq 'annualSavingsAmount') {
                                        $annualSavingsIndex = $i
                                    }
                                    if ($keysArray[$i] -eq 'savingsCurrency') {
                                        $currencyIndex = $i
                                    }
                                }
                            }
                            
                            # Convert Values to array if needed (if not already converted above)
                            if (-not (Test-Path variable:valuesArray)) {
                                $valuesArray = @($metadata.Values)
                            }
                            
                            if ($annualSavingsIndex -ge 0 -and $annualSavingsIndex -lt $valuesArray.Count) {
                                try {
                                    $savingsValue = $valuesArray[$annualSavingsIndex]
                                    $potentialSavings = [decimal]$savingsValue
                                    if ($processedCount -lt 3) {
                                        Write-Host "    [DEBUG] Parsed annualSavingsAmount from Metadata.Values[$annualSavingsIndex]: $potentialSavings" -ForegroundColor Green
                                    }
                                } catch {
                                    Write-Host "    [DEBUG] Failed to parse annualSavingsAmount from Metadata.Values[$annualSavingsIndex]: $($valuesArray[$annualSavingsIndex]) - $_" -ForegroundColor Red
                                }
                            }
                            
                            if ($currencyIndex -ge 0 -and $currencyIndex -lt $valuesArray.Count) {
                                $savingsCurrency = $valuesArray[$currencyIndex]
                            }
                        }
                        
                        # Try direct properties on Metadata object
                        if (-not $potentialSavings) {
                            if ($metadata.annualSavingsAmount) {
                                try {
                                    $savingsValue = $metadata.annualSavingsAmount
                                    $potentialSavings = [decimal]$savingsValue
                                    if ($processedCount -lt 3) {
                                        Write-Host "    [DEBUG] Parsed annualSavingsAmount from Metadata direct property: $potentialSavings" -ForegroundColor Green
                                    }
                                } catch {
                                    Write-Host "    [DEBUG] Failed to parse annualSavingsAmount from Metadata direct: $($metadata.annualSavingsAmount) - $_" -ForegroundColor Red
                                }
                            }
                            if ($metadata.savingsCurrency) {
                                $savingsCurrency = $metadata.savingsCurrency
                            }
                        }
                    }
                    
                    # Fallback to PotentialBenefit (direct property)
                    if (-not $potentialSavings -and $rec.PotentialBenefit) {
                        try {
                            $potentialSavings = [decimal]$rec.PotentialBenefit
                        } catch {
                            Write-Verbose "Failed to parse PotentialBenefit: $($rec.PotentialBenefit)"
                        }
                    }
                    
                    # Fallback to ExtendedProperty
                    if (-not $potentialSavings) {
                        $extendedProps = if ($rec.ExtendedProperty) { $rec.ExtendedProperty } elseif ($rec.ExtendedProperties) { $rec.ExtendedProperties } elseif ($rec.properties.extendedProperties) { $rec.properties.extendedProperties } else { $null }
                        
                        if ($extendedProps) {
                            if ($extendedProps -is [Hashtable]) {
                                if ($extendedProps.ContainsKey('annualSavingsAmount')) {
                                    try {
                                        $potentialSavings = [decimal]$extendedProps['annualSavingsAmount']
                                    } catch {
                                        Write-Verbose "Failed to parse annualSavingsAmount from ExtendedProperty"
                                    }
                                }
                                if ($extendedProps.ContainsKey('savingsCurrency') -and -not $savingsCurrency) {
                                    $savingsCurrency = $extendedProps['savingsCurrency']
                                }
                            } else {
                                if ($extendedProps.annualSavingsAmount) {
                                    try {
                                        $potentialSavings = [decimal]$extendedProps.annualSavingsAmount
                                    } catch {
                                        Write-Verbose "Failed to parse annualSavingsAmount from ExtendedProperty"
                                    }
                                }
                                if ($extendedProps.savingsCurrency -and -not $savingsCurrency) {
                                    $savingsCurrency = $extendedProps.savingsCurrency
                                }
                            }
                        }
                    }
                    
                    # Default currency if not found
                    if (-not $savingsCurrency) {
                        $savingsCurrency = "USD"
                    }
                    
                    if ($processedCount -lt 3) {
                        Write-Host "    [DEBUG] Cost recommendation - PotentialSavings=$potentialSavings, Currency=$savingsCurrency" -ForegroundColor $(if ($potentialSavings) { 'Green' } else { 'Yellow' })
                        if (-not $potentialSavings) {
                            Write-Host "    [DEBUG] WARNING: No PotentialSavings found for Cost recommendation!" -ForegroundColor Red
                            if ($metadata) {
                                Write-Host "    [DEBUG] Metadata exists but parsing failed. Full Metadata structure:" -ForegroundColor Yellow
                                Write-Host "    [DEBUG] $($metadata | ConvertTo-Json -Depth 5)" -ForegroundColor Gray
                            } else {
                                Write-Host "    [DEBUG] No Metadata found for this Cost recommendation" -ForegroundColor Yellow
                            }
                        }
                    }
                }
                
                $lastUpdated = if ($rec.LastUpdated) { $rec.LastUpdated } elseif ($rec.properties.lastUpdated) { $rec.properties.lastUpdated } else { $null }
                $recommendationType = if ($rec.RecommendationTypeId) { $rec.RecommendationTypeId } elseif ($rec.properties.recommendationTypeId) { $rec.properties.recommendationTypeId } else { "Unknown" }
                
                # Get LearnMoreLink and Description
                $learnMoreLink = if ($rec.LearnMoreLink) { $rec.LearnMoreLink } elseif ($rec.properties.learnMoreLink) { $rec.properties.learnMoreLink } else { $null }
                
                # Get Description - this is the detailed recommendation description
                $fullDescription = if ($rec.Description) { $rec.Description } elseif ($rec.properties.description) { $rec.properties.description } else { $null }
                
                # Get LongDescription - contains detailed recommendation information
                # Try multiple sources and formats for comprehensive description
                $longDescription = $null
                
                # Method 1: Direct LongDescription property (string or object)
                if ($rec.LongDescription) {
                    if ($rec.LongDescription -is [string] -and -not [string]::IsNullOrWhiteSpace($rec.LongDescription)) {
                        $longDescription = $rec.LongDescription.Trim()
                    } elseif ($rec.LongDescription.Problem -and -not [string]::IsNullOrWhiteSpace($rec.LongDescription.Problem)) {
                        $longDescription = $rec.LongDescription.Problem.ToString().Trim()
                    } elseif ($rec.LongDescription.Description -and -not [string]::IsNullOrWhiteSpace($rec.LongDescription.Description)) {
                        $longDescription = $rec.LongDescription.Description.ToString().Trim()
                    } elseif ($rec.LongDescription.Text -and -not [string]::IsNullOrWhiteSpace($rec.LongDescription.Text)) {
                        $longDescription = $rec.LongDescription.Text.ToString().Trim()
                    }
                } elseif ($rec.properties.longDescription) {
                    if ($rec.properties.longDescription -is [string] -and -not [string]::IsNullOrWhiteSpace($rec.properties.longDescription)) {
                        $longDescription = $rec.properties.longDescription.Trim()
                    } elseif ($rec.properties.longDescription.problem -and -not [string]::IsNullOrWhiteSpace($rec.properties.longDescription.problem)) {
                        $longDescription = $rec.properties.longDescription.problem.ToString().Trim()
                    } elseif ($rec.properties.longDescription.description -and -not [string]::IsNullOrWhiteSpace($rec.properties.longDescription.description)) {
                        $longDescription = $rec.properties.longDescription.description.ToString().Trim()
                    } elseif ($rec.properties.longDescription.text -and -not [string]::IsNullOrWhiteSpace($rec.properties.longDescription.text)) {
                        $longDescription = $rec.properties.longDescription.text.ToString().Trim()
                    }
                }
                
                # Method 2: If LongDescription is empty, try Description (detailed description)
                if ([string]::IsNullOrWhiteSpace($longDescription) -and $fullDescription -and -not [string]::IsNullOrWhiteSpace($fullDescription)) {
                    # Only use Description if it's different from Problem and longer
                    if ($fullDescription -ne $problem -and $fullDescription.Length -gt $problem.Length) {
                        $longDescription = $fullDescription.Trim()
                    }
                }
                
                # Method 3: Try ExtendedProperty for detailed description
                if ([string]::IsNullOrWhiteSpace($longDescription) -and $rec.ExtendedProperty) {
                    $extProps = $rec.ExtendedProperty
                    if ($extProps -is [Hashtable] -or $extProps -is [System.Collections.IDictionary]) {
                        if ($extProps.ContainsKey('longDescription')) {
                            $longDescValue = $extProps['longDescription']
                            if ($longDescValue -and -not [string]::IsNullOrWhiteSpace($longDescValue)) {
                                $longDescription = $longDescValue.ToString().Trim()
                            }
                        } elseif ($extProps.ContainsKey('description')) {
                            $descValue = $extProps['description']
                            if ($descValue -and -not [string]::IsNullOrWhiteSpace($descValue) -and $descValue -ne $problem) {
                                $longDescription = $descValue.ToString().Trim()
                            }
                        }
                    } else {
                        if ($extProps.longDescription -and -not [string]::IsNullOrWhiteSpace($extProps.longDescription)) {
                            $longDescription = $extProps.longDescription.ToString().Trim()
                        } elseif ($extProps.description -and -not [string]::IsNullOrWhiteSpace($extProps.description) -and $extProps.description -ne $problem) {
                            $longDescription = $extProps.description.ToString().Trim()
                        }
                    }
                }
                
                # Get Potential Benefits - from ExtendedProperty or PotentialBenefit
                $potentialBenefits = $null
                if ($rec.PotentialBenefit) {
                    $potentialBenefits = $rec.PotentialBenefit
                } elseif ($rec.ExtendedProperty) {
                    if ($rec.ExtendedProperty -is [Hashtable]) {
                        if ($rec.ExtendedProperty.ContainsKey('potentialBenefits')) {
                            $potentialBenefits = $rec.ExtendedProperty['potentialBenefits']
                        } elseif ($rec.ExtendedProperty.ContainsKey('benefits')) {
                            $potentialBenefits = $rec.ExtendedProperty['benefits']
                        }
                    } else {
                        if ($rec.ExtendedProperty.potentialBenefits) {
                            $potentialBenefits = $rec.ExtendedProperty.potentialBenefits
                        } elseif ($rec.ExtendedProperty.benefits) {
                            $potentialBenefits = $rec.ExtendedProperty.benefits
                        }
                    }
                }
                
                # Get additional metadata
                $label = if ($rec.Label) { $rec.Label } elseif ($rec.properties.label) { $rec.properties.label } else { $null }
                $risk = if ($rec.Risk) { $rec.Risk } elseif ($rec.properties.risk) { $rec.properties.risk } else { $null }
                $action = if ($rec.Action) { $rec.Action } elseif ($rec.properties.action) { $rec.properties.action } else { $null }
                
                # Get Remediation - can be an object with additionalProperties (httpMethod, uri, details)
                $remediation = $null
                $remediationUri = $null
                $remediationMethod = $null
                $remediationDetails = $null
                
                $remediationObj = if ($rec.Remediation) { $rec.Remediation } elseif ($rec.properties.remediation) { $rec.properties.remediation } else { $null }
                if ($remediationObj) {
                    if ($remediationObj -is [string]) {
                        $remediation = $remediationObj
                    } elseif ($remediationObj.additionalProperties) {
                        $remediationDetails = if ($remediationObj.additionalProperties.details) { $remediationObj.additionalProperties.details } else { $null }
                        $remediationUri = if ($remediationObj.additionalProperties.uri) { $remediationObj.additionalProperties.uri } else { $null }
                        $remediationMethod = if ($remediationObj.additionalProperties.httpMethod) { $remediationObj.additionalProperties.httpMethod } else { $null }
                        # Use details as remediation text if available
                        $remediation = if ($remediationDetails) { $remediationDetails } elseif ($remediationUri) { $remediationUri } else { $null }
                    } elseif ($remediationObj.details) {
                        $remediation = $remediationObj.details
                        $remediationUri = if ($remediationObj.uri) { $remediationObj.uri } else { $null }
                        $remediationMethod = if ($remediationObj.httpMethod) { $remediationObj.httpMethod } else { $null }
                    } else {
                        $remediation = $remediationObj.ToString()
                    }
                }
                
                # Get ExposedMetadataProperties (recommendation metadata properties exposed to customer)
                $exposedMetadataProperties = $null
                $exposedMetadataPropertiesJson = $null
                if ($rec.ExposedMetadataProperties) {
                    $exposedMetadataProperties = $rec.ExposedMetadataProperties
                } elseif ($rec.properties.exposedMetadataProperties) {
                    $exposedMetadataProperties = $rec.properties.exposedMetadataProperties
                }
                if ($exposedMetadataProperties) {
                    try {
                        $exposedMetadataPropertiesJson = ($exposedMetadataProperties | ConvertTo-Json -Depth 10 -Compress)
                    } catch {
                        Write-Verbose "Failed to serialize ExposedMetadataProperties to JSON"
                    }
                }
                
                # Get ResourceMetadata details
                $resourceMetadataAction = if ($rec.ResourceMetadataAction) { $rec.ResourceMetadataAction } else { $null }
                $resourceMetadataSource = if ($rec.ResourceMetadataSource) { $rec.ResourceMetadataSource } else { $null }
                $resourceMetadataSingular = if ($rec.ResourceMetadataSingular) { $rec.ResourceMetadataSingular } else { $null }
                $resourceMetadataPlural = if ($rec.ResourceMetadataPlural) { $rec.ResourceMetadataPlural } else { $null }
                
                # Get ExtendedProperty as JSON string for detailed view
                $extendedPropertyJson = $null
                if ($rec.ExtendedProperty) {
                    try {
                        $extendedPropertyJson = ($rec.ExtendedProperty | ConvertTo-Json -Depth 10 -Compress)
                    } catch {
                        Write-Verbose "Failed to serialize ExtendedProperty to JSON"
                    }
                } elseif ($rec.ExtendedProperties) {
                    try {
                        $extendedPropertyJson = ($rec.ExtendedProperties | ConvertTo-Json -Depth 10 -Compress)
                    } catch {
                        Write-Verbose "Failed to serialize ExtendedProperties to JSON"
                    }
                }
                
                # Get Metadata as JSON string
                $metadataJson = $null
                if ($rec.Metadata) {
                    try {
                        $metadataJson = ($rec.Metadata | ConvertTo-Json -Depth 10 -Compress)
                    } catch {
                        Write-Verbose "Failed to serialize Metadata to JSON"
                    }
                }
                
                if ($processedCount -lt 3) {
                    Write-Host "    [DEBUG] Problem='$problem', Solution='$solution', LearnMoreLink='$learnMoreLink'" -ForegroundColor Gray
                    Write-Host "    [DEBUG] Label='$label', Risk='$risk', Action='$action', Remediation='$remediation'" -ForegroundColor Gray
                    Write-Host "    [DEBUG] LongDescription='$longDescription', PotentialBenefits='$potentialBenefits'" -ForegroundColor Gray
                }
                
                # Build recommendation object
                $recObj = [PSCustomObject]@{
                    SubscriptionId          = $SubscriptionId
                    SubscriptionName        = $SubscriptionName
                    RecommendationId        = $recId
                    Category                = $recCategory
                    Impact                  = $recImpact
                    ImpactedField           = $recImpactedField
                    ResourceId              = $recResourceId
                    ResourceName            = $resourceName
                    ResourceGroup           = $resourceGroup
                    ResourceType            = $recImpactedField
                    Problem                 = $problem
                    Solution                = $solution
                    Description             = $fullDescription
                    LongDescription         = $longDescription
                    PotentialBenefits       = $potentialBenefits
                    LearnMoreLink           = $learnMoreLink
                    Label                   = $label
                    Risk                    = $risk
                    Action                  = $action
                    Remediation             = $remediation
                    RemediationUri          = $remediationUri
                    RemediationMethod       = $remediationMethod
                    RemediationDetails      = $remediationDetails
                    ResourceMetadataAction  = $resourceMetadataAction
                    ResourceMetadataSource  = $resourceMetadataSource
                    ResourceMetadataSingular = $resourceMetadataSingular
                    ResourceMetadataPlural  = $resourceMetadataPlural
                    ExtendedPropertyJson    = $extendedPropertyJson
                    MetadataJson            = $metadataJson
                    ExposedMetadataPropertiesJson = $exposedMetadataPropertiesJson
                    PotentialSavings        = $potentialSavings
                    SavingsCurrency         = $savingsCurrency
                    LastUpdated             = $lastUpdated
                    RecommendationType      = $recommendationType
                    RecommendationTypeId    = $recommendationType  # Alias for compatibility
                }
                
                $recommendations.Add($recObj)
                $processedCount++
            }
            catch {
                $skippedCount++
                Write-Host "    [DEBUG] Failed to parse Advisor recommendation $($skippedCount): $_" -ForegroundColor Red
                Write-Host "    [DEBUG] Recommendation object keys: $($rec.PSObject.Properties.Name -join ', ')" -ForegroundColor Gray
            }
        }
        
        Write-Host "    [DEBUG] Processed $processedCount recommendations, skipped $skippedCount" -ForegroundColor Yellow
    }
    catch {
        Write-Warning "Failed to retrieve Advisor recommendations for subscription $SubscriptionName : $_"
    }
    
    return $recommendations
}

