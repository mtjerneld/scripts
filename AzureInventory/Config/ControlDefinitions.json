{
  "metadata": {
    "version": "3.0",
    "cisVersion": "CIS Microsoft Azure Foundations Benchmark v4.0.0",
    "lastUpdated": "2025-01-09",
    "description": "Control definitions for Azure Security Audit Tool aligned with CIS v4.0.0 L1. Supports multiple frameworks (CIS, ASB, etc.)"
  },
  "controls": [
    {
      "controlId": "10.3.7",
      "controlName": "Minimum TLS Version 1.2",
      "category": "Storage",
      "frameworks": ["CIS", "ASB"],
      "priority": "P0",
      "level": "L1",
      "severity": "Critical",
      "automated": true,
      "commercial": false,
      "propertyPath": "properties.minimumTlsVersion",
      "expectedValue": "TLS1_2",
      "checkLogic": "value == 'TLS1_2' or value == 'TLS1_3'",
      "valueMapping": {
        "TLS1_0": "TLS 1.0 (Insecure - EOL Feb 2026)",
        "TLS1_1": "TLS 1.1 (Insecure - EOL Feb 2026)",
        "TLS1_2": "TLS 1.2 (Secure)",
        "TLS1_3": "TLS 1.3 (Secure)",
        "null": "Not configured (defaults to TLS 1.0)"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Storage/storageAccounts?api-version=2024-01-01",
      "cliCommand": "az storage account show --name {name} --resource-group {rg} --query minimumTlsVersion",
      "remediationCommand": "az storage account update --name {name} --resource-group {rg} --min-tls-version TLS1_2",
      "businessImpact": "Prevents use of insecure TLS 1.0/1.1 protocols. TLS 1.0/1.1 will be deprecated in February 2026. EOL tracking is handled via Microsoft's official EOL lists.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/storage/common/transport-layer-security-configure-minimum-version",
        "https://workbench.cisecurity.org/files/3459",
        "https://www.tenable.com/audits/items/CIS_Microsoft_Azure_Foundations_L1_v1.3.1.audit:[UPDATE_WITH_TENABLE_HASH_FOR_3.15]"
      ],
      "description": "Prevents use of insecure TLS 1.0/1.1 protocols. TLS 1.0/1.1 will be deprecated in February 2026. This control is part of the CIS Microsoft Azure Foundations Benchmark."
    },
    {
      "controlId": "10.3.4",
      "controlName": "Secure Transfer Required",
      "category": "Storage",
      "frameworks": ["CIS", "ASB"],
      "priority": "P0",
      "level": "L1",
      "severity": "High",
      "automated": true,
      "commercial": false,
      "propertyPath": "properties.supportsHttpsTrafficOnly",
      "expectedValue": "true",
      "checkLogic": "value == true",
      "valueMapping": {
        "true": "Enabled (Secure)",
        "false": "Disabled (Insecure)"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Storage/storageAccounts?api-version=2024-01-01",
      "cliCommand": "az storage account show --name {name} --resource-group {rg} --query enableHttpsTrafficOnly",
      "remediationCommand": "az storage account update --name {name} --resource-group {rg} --https-only true",
      "businessImpact": "Enforces HTTPS-only traffic to prevent unencrypted data transfer.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/storage/common/storage-require-secure-transfer",
        "https://workbench.cisecurity.org/files/3459",
        "https://www.tenable.com/audits/items/CIS_Microsoft_Azure_Foundations_L1_v1.3.1.audit:[UPDATE_WITH_TENABLE_HASH_FOR_3.1]"
      ],
      "description": "Enforces HTTPS-only traffic to prevent unencrypted data transfer. This control is part of the CIS Microsoft Azure Foundations Benchmark."
    },
    {
      "controlId": "10.3.6",
      "controlName": "Soft Delete for Blobs",
      "category": "Storage",
      "frameworks": ["CIS", "ASB"],
      "priority": "P1",
      "level": "L1",
      "severity": "High",
      "automated": true,
      "commercial": false,
      "propertyPath": "properties.deleteRetentionPolicy.enabled",
      "expectedValue": "true",
      "checkLogic": "value == true",
      "valueMapping": {
        "true": "Soft Delete Enabled (Secure)",
        "false": "Soft Delete Disabled (Insecure)"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Storage/storageAccounts/{name}/blobServices/default?api-version=2023-01-01",
      "cliCommand": "az storage account blob-service-properties show --account-name {name} --resource-group {rg} --query deleteRetentionPolicy.enabled",
      "remediationCommand": "az storage account blob-service-properties update --account-name {name} --resource-group {rg} --enable-delete-retention true --delete-retention-days 7",
      "businessImpact": "Protects data from accidental or malicious deletion. Allows recovery within retention period.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/storage/blobs/soft-delete-blob-overview",
        "https://workbench.cisecurity.org/files/3459"
      ],
      "description": "Ensure that 'Soft Delete' is enabled for Blob Storage. This allows recovery of deleted blobs and snapshots."
    },
    {
      "controlId": "10.3.9",
      "controlName": "Public Blob Access",
      "category": "Storage",
      "frameworks": ["CIS", "ASB"],
      "priority": "P0",
      "level": "L1",
      "severity": "High",
      "automated": true,
      "commercial": false,
      "propertyPath": "properties.allowBlobPublicAccess",
      "expectedValue": "false",
      "checkLogic": "value == false",
      "valueMapping": {
        "true": "Allowed (Public access enabled)",
        "false": "Blocked (Public access disabled)"
      },
      "exceptions": [
        {
          "condition": "properties.primaryEndpoints.web != null",
          "reason": "Static Website hosting requires public blob access",
          "adjustedSeverity": "Low",
          "status": "REVIEW"
        },
        {
          "condition": "tags.public-access == 'approved'",
          "reason": "Explicitly approved for public access",
          "adjustedSeverity": "Low",
          "status": "ACCEPTED"
        },
        {
          "condition": "tags.environment in ['dev', 'test', 'sandbox']",
          "reason": "Development/test environment",
          "adjustedSeverity": "Medium",
          "status": "REVIEW"
        }
      ],
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Storage/storageAccounts?api-version=2024-01-01",
      "cliCommand": "az storage account show --name {name} --resource-group {rg} --query allowBlobPublicAccess",
      "remediationCommand": "az storage account update --name {name} --resource-group {rg} --allow-blob-public-access false",
      "businessImpact": "Prevents unauthorized public access to blob containers. May break Static Website hosting.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/storage/blobs/anonymous-read-access-configure",
        "https://workbench.cisecurity.org/files/3459",
        "https://www.tenable.com/audits/items/CIS_Microsoft_Azure_Foundations_L1_v1.3.1.audit:[UPDATE_WITH_TENABLE_HASH_FOR_3.7]"
      ],
      "description": "Prevents unauthorized public access to blob containers. May break Static Website hosting. This control is part of the CIS Microsoft Azure Foundations Benchmark."
    },
    {
      "controlId": "10.3.2.3",
      "controlName": "Default Network Access",
      "category": "Storage",
      "frameworks": ["CIS", "ASB"],
      "priority": "P0",
      "level": "L1",
      "severity": "High",
      "automated": true,
      "commercial": false,
      "propertyPath": "properties.networkAcls.defaultAction",
      "expectedValue": "Deny",
      "checkLogic": "value == 'Deny'",
      "valueMapping": {
        "Allow": "Allow (All networks can access)",
        "Deny": "Deny (Only selected networks can access)"
      },
      "exceptions": [
        {
          "condition": "properties.primaryEndpoints.web != null",
          "reason": "Static Website hosting may require public network access",
          "adjustedSeverity": "Medium",
          "status": "REVIEW"
        },
        {
          "condition": "tags.network-access == 'public-required'",
          "reason": "Public network access documented as required",
          "adjustedSeverity": "Low",
          "status": "ACCEPTED"
        },
        {
          "condition": "tags.environment in ['dev', 'test']",
          "reason": "Development/test environment",
          "adjustedSeverity": "Medium",
          "status": "REVIEW"
        }
      ],
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Storage/storageAccounts?api-version=2024-01-01",
      "cliCommand": "az storage account show --name {name} --resource-group {rg} --query networkRuleSet.defaultAction",
      "remediationCommand": "az storage account update --name {name} --resource-group {rg} --default-action Deny",
      "businessImpact": "Implements zero-trust network security by denying access by default. Requires explicit VNet/IP whitelist configuration.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/storage/common/storage-network-security",
        "https://workbench.cisecurity.org/files/3459",
        "https://www.tenable.com/audits/items/CIS_Microsoft_Azure_Foundations_L1_v1.3.1.audit:[UPDATE_WITH_TENABLE_HASH_FOR_3.8]"
      ],
      "description": "Implements zero-trust network security by denying access by default. Requires explicit VNet/IP whitelist configuration. This control is part of the CIS Microsoft Azure Foundations Benchmark."
    },
    {
      "controlId": "N/A",
      "controlName": "Storage Account Kind (Legacy Detection)",
      "category": "Storage",
      "frameworks": ["CIS"],
      "priority": "P1",
      "level": "N/A",
      "severity": "Medium",
      "automated": true,
      "commercial": false,
      "propertyPath": "kind",
      "expectedValue": "StorageV2",
      "checkLogic": "value not in ['Storage', 'BlobStorage']",
      "valueMapping": {
        "StorageV2": "General Purpose v2 (Current)",
        "Storage": "General Purpose v1 (Legacy - EOL Oct 2026)",
        "BlobStorage": "Blob Storage (Legacy - EOL Oct 2026)",
        "FileStorage": "File Storage (Specialized)",
        "BlockBlobStorage": "Block Blob Storage (Specialized)"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Storage/storageAccounts?api-version=2024-01-01",
      "cliCommand": "az storage account show --name {name} --resource-group {rg} --query kind",
      "remediationCommand": "az storage account update --name {name} --resource-group {rg} --set kind=StorageV2",
      "businessImpact": "Legacy storage account types (GPv1, BlobStorage) are being deprecated October 2026. Upgrade to StorageV2 for full feature support. EOL tracking is handled via Microsoft's official EOL lists.",
      "references": [
        "https://azure.microsoft.com/en-us/updates/action-required-switch-to-azure-storage-account-standard-general-purpose-v2-by-13-october-2026/"
      ],
      "description": "Legacy storage account types (GPv1, BlobStorage) are being deprecated October 2026. Upgrade to StorageV2 for full feature support."
    },
    {
      "controlId": "10.1.1",
      "controlName": "Soft Delete for Azure File Shares",
      "category": "Storage",
      "frameworks": ["CIS"],
      "priority": "P1",
      "level": "L1",
      "severity": "Medium",
      "automated": true,
      "commercial": false,
      "propertyPath": "properties.shareDeleteRetentionPolicy.enabled",
      "expectedValue": "true",
      "checkLogic": "value == true",
      "valueMapping": {
        "true": "Soft delete enabled",
        "false": "Soft delete disabled"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Storage/storageAccounts/{accountName}/fileServices/default?api-version=2024-01-01",
      "cliCommand": "az storage share-rm show --storage-account {accountName} --name {shareName} --query shareDeleteRetentionPolicy.enabled",
      "remediationCommand": "az storage account file-service-properties update --account-name {accountName} --enable-delete-retention true --delete-retention-days 7",
      "businessImpact": "Enables soft delete for Azure File Shares to protect against accidental or malicious deletion. Files can be recovered within the retention period.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/storage/files/storage-files-enable-soft-delete",
        "https://workbench.cisecurity.org/files/3459"
      ],
      "description": "Ensure soft delete is enabled for Azure File Shares to protect against accidental or malicious deletion. This control is part of the CIS Microsoft Azure Foundations Benchmark."
    },
    {
      "controlId": "10.1.2",
      "controlName": "SMB Protocol Version 3.1.1 or Higher",
      "category": "Storage",
      "frameworks": ["CIS"],
      "priority": "P1",
      "level": "L1",
      "severity": "Medium",
      "automated": true,
      "commercial": false,
      "propertyPath": "properties.protocolSettings.smb.versions",
      "expectedValue": "SMB 3.1.1 or higher",
      "checkLogic": "value contains 'SMB3.1.1' or value contains 'SMB3.1.1'",
      "valueMapping": {
        "SMB3.1.1": "SMB 3.1.1 (Secure)",
        "SMB3.0": "SMB 3.0 (Less secure)",
        "SMB2.1": "SMB 2.1 (Insecure)"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Storage/storageAccounts/{accountName}/fileServices/default?api-version=2024-01-01",
      "cliCommand": "az storage account file-service-properties show --account-name {accountName} --query protocolSettings.smb.versions",
      "remediationCommand": "az storage account file-service-properties update --account-name {accountName} --versions SMB3.1.1",
      "businessImpact": "Ensures Azure File Shares use SMB 3.1.1 or higher protocol for enhanced security features including encryption.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/storage/files/files-smb-protocol",
        "https://workbench.cisecurity.org/files/3459"
      ],
      "description": "Ensure Azure File Shares use SMB protocol version 3.1.1 or higher for enhanced security features. This control is part of the CIS Microsoft Azure Foundations Benchmark."
    },
    {
      "controlId": "10.1.3",
      "controlName": "SMB Channel Encryption AES-256-GCM",
      "category": "Storage",
      "frameworks": ["CIS"],
      "priority": "P1",
      "level": "L1",
      "severity": "Medium",
      "automated": true,
      "commercial": false,
      "propertyPath": "properties.protocolSettings.smb.authenticationMethods",
      "expectedValue": "AES-256-GCM encryption enabled",
      "checkLogic": "value contains 'AES-256-GCM' or encryption is enabled",
      "valueMapping": {
        "AES-256-GCM": "AES-256-GCM encryption enabled",
        "disabled": "Channel encryption disabled"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Storage/storageAccounts/{accountName}/fileServices/default?api-version=2024-01-01",
      "cliCommand": "az storage account file-service-properties show --account-name {accountName} --query protocolSettings.smb.authenticationMethods",
      "remediationCommand": "az storage account file-service-properties update --account-name {accountName} --enable-smb-channel-encryption true",
      "businessImpact": "Enables AES-256-GCM channel encryption for SMB connections to Azure File Shares, providing end-to-end encryption.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/storage/files/files-smb-protocol",
        "https://workbench.cisecurity.org/files/3459"
      ],
      "description": "Ensure SMB channel encryption using AES-256-GCM is enabled for Azure File Shares. This control is part of the CIS Microsoft Azure Foundations Benchmark."
    },
    {
      "controlId": "10.3.8",
      "controlName": "Cross Tenant Replication Disabled",
      "category": "Storage",
      "frameworks": ["CIS"],
      "priority": "P1",
      "level": "L1",
      "severity": "Medium",
      "automated": true,
      "commercial": false,
      "propertyPath": "properties.allowCrossTenantReplication",
      "expectedValue": "false",
      "checkLogic": "value == false",
      "valueMapping": {
        "true": "Cross tenant replication enabled (Risk)",
        "false": "Cross tenant replication disabled (Secure)"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Storage/storageAccounts?api-version=2024-01-01",
      "cliCommand": "az storage account show --name {name} --resource-group {rg} --query allowCrossTenantReplication",
      "remediationCommand": "az storage account update --name {name} --resource-group {rg} --allow-cross-tenant-replication false",
      "businessImpact": "Prevents cross-tenant replication to reduce risk of unauthorized data access across Azure AD tenants.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/storage/common/object-replication-overview",
        "https://workbench.cisecurity.org/files/3459"
      ],
      "description": "Ensure cross tenant replication is disabled for storage accounts to prevent unauthorized data access across Azure AD tenants. This control is part of the CIS Microsoft Azure Foundations Benchmark."
    },
    {
      "controlId": "10.3.10",
      "controlName": "Azure Resource Manager Delete Locks",
      "category": "Storage",
      "frameworks": ["CIS"],
      "priority": "P1",
      "level": "L1",
      "severity": "Medium",
      "automated": false,
      "commercial": false,
      "propertyPath": "locks",
      "expectedValue": "Delete lock exists",
      "checkLogic": "delete lock exists",
      "valueMapping": {
        "exists": "Delete lock configured",
        "not_exists": "Delete lock not configured"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/resourceGroups/{rg}/providers/Microsoft.Storage/storageAccounts/{name}/providers/Microsoft.Authorization/locks?api-version=2020-05-01",
      "cliCommand": "az lock list --resource-group {rg} --resource {resourceId} --resource-type Microsoft.Storage/storageAccounts",
      "remediationCommand": "az lock create --name DeleteLock --lock-type CanNotDelete --resource-group {rg} --resource {resourceId} --resource-type Microsoft.Storage/storageAccounts",
      "businessImpact": "Prevents accidental deletion of storage accounts by requiring explicit lock removal before deletion.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/lock-resources",
        "https://workbench.cisecurity.org/files/3459"
      ],
      "description": "Ensure Azure Resource Manager delete locks are configured for storage accounts to prevent accidental deletion. This control is part of the CIS Microsoft Azure Foundations Benchmark."
    },
    {
      "controlId": "4.1.2",
      "controlName": "SQL Firewall - No Allow All",
      "category": "SQL",
      "frameworks": ["CIS", "ASB"],
      "priority": "P0",
      "level": "L1",
      "severity": "Critical",
      "automated": true,
      "commercial": false,
      "propertyPath": "firewallRules",
      "expectedValue": "No rule with 0.0.0.0-255.255.255.255 or 0.0.0.0-0.0.0.0",
      "checkLogic": "no rule where (startIpAddress == '0.0.0.0' AND endIpAddress in ['0.0.0.0', '255.255.255.255'])",
      "valueMapping": {
        "0.0.0.0-255.255.255.255": "Allow from all internet (Critical risk)",
        "0.0.0.0-0.0.0.0": "Allow Azure services (Medium risk)",
        "Specific IP/Range": "Restricted access (Secure)"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Sql/servers/{serverName}/firewallRules?api-version=2023-08-01",
      "cliCommand": "az sql server firewall-rule list --server {serverName} --resource-group {rg}",
      "remediationCommand": "az sql server firewall-rule delete --server {serverName} --resource-group {rg} --name {ruleName}",
      "businessImpact": "Prevents exposure of SQL databases to the entire internet. The most common attack vector for SQL breaches.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/azure-sql/database/firewall-configure",
        "https://workbench.cisecurity.org/files/3459",
        "https://www.tenable.com/audits/items/CIS_Microsoft_Azure_Foundations_L1_v1.3.1.audit:[UPDATE_WITH_TENABLE_HASH_FOR_4.1.2]"
      ],
      "description": "Prevents exposure of SQL databases to the entire internet. The most common attack vector for SQL breaches. This control is part of the CIS Microsoft Azure Foundations Benchmark."
    },
    {
      "controlId": "4.1.1",
      "controlName": "SQL Auditing Enabled",
      "category": "SQL",
      "frameworks": ["CIS", "ASB"],
      "priority": "P0",
      "level": "L1",
      "severity": "High",
      "automated": true,
      "commercial": false,
      "propertyPath": "auditingSettings/default.properties.state",
      "expectedValue": "Enabled",
      "checkLogic": "value == 'Enabled'",
      "valueMapping": {
        "Enabled": "Auditing enabled",
        "Disabled": "Auditing disabled"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Sql/servers/{serverName}/auditingSettings/default?api-version=2023-08-01",
      "cliCommand": "az sql server audit-policy show --resource-group {rg} --server {serverName}",
      "remediationCommand": "az sql server audit-policy update --resource-group {rg} --server {serverName} --state Enabled --storage-account {storageAccount}",
      "businessImpact": "Enables tracking of database activities and security events for compliance and forensic analysis. Required for most compliance frameworks.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/azure-sql/database/auditing-overview",
        "https://workbench.cisecurity.org/files/3459",
        "https://www.tenable.com/audits/items/CIS_Microsoft_Azure_Foundations_L1_v1.3.1.audit:[UPDATE_WITH_TENABLE_HASH_FOR_4.1.1]"
      ],
      "description": "Enables tracking of database activities and security events for compliance and forensic analysis. Required for most compliance frameworks. This control is part of the CIS Microsoft Azure Foundations Benchmark."
    },
    {
      "controlId": "4.1.5",
      "controlName": "Transparent Data Encryption (TDE)",
      "category": "SQL",
      "frameworks": ["CIS", "ASB"],
      "priority": "P0",
      "level": "L1",
      "severity": "High",
      "automated": true,
      "commercial": false,
      "propertyPath": "transparentDataEncryption/current.properties.state",
      "expectedValue": "Enabled",
      "checkLogic": "value == 'Enabled'",
      "valueMapping": {
        "Enabled": "Encryption enabled",
        "Disabled": "Encryption disabled"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Sql/servers/{serverName}/databases/{dbName}/transparentDataEncryption/current?api-version=2023-08-01",
      "cliCommand": "az sql db tde show --server {serverName} --database {dbName} --resource-group {rg}",
      "remediationCommand": "az sql db tde set --resource-group {rg} --server {serverName} --database {dbName} --status Enabled",
      "businessImpact": "Encrypts data at rest to protect sensitive information. Native Azure SQL feature with no performance impact.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/azure-sql/database/transparent-data-encryption-tde-overview",
        "https://workbench.cisecurity.org/files/3459",
        "https://www.tenable.com/audits/items/CIS_Microsoft_Azure_Foundations_L1_v1.3.1.audit:[UPDATE_WITH_TENABLE_HASH_FOR_4.1.5]"
      ],
      "description": "Encrypts data at rest to protect sensitive information. Native Azure SQL feature with no performance impact. This control is part of the CIS Microsoft Azure Foundations Benchmark."
    },
    {
      "controlId": "N/A",
      "controlName": "SQL Server - TLS Version",
      "category": "SQL",
      "frameworks": ["CIS", "ASB"],
      "priority": "P0",
      "level": "L1",
      "severity": "Critical",
      "automated": true,
      "commercial": false,
      "propertyPath": "properties.minimalTlsVersion",
      "expectedValue": "1.2",
      "checkLogic": "value == '1.2' or value == '1.3'",
      "valueMapping": {
        "1.0": "TLS 1.0 (Insecure)",
        "1.1": "TLS 1.1 (Insecure)",
        "1.2": "TLS 1.2 (Secure)",
        "1.3": "TLS 1.3 (Secure)",
        "null": "Not configured"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Sql/servers/{serverName}?api-version=2023-08-01",
      "cliCommand": "az sql server show --name {serverName} --resource-group {rg} --query minimalTlsVersion",
      "remediationCommand": "az sql server update --name {serverName} --resource-group {rg} --minimal-tls-version 1.2",
      "businessImpact": "Enforces secure TLS connections for SQL Server. Prevents use of deprecated TLS 1.0/1.1.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/azure-sql/database/connectivity-settings#minimal-tls-version"
      ],
      "description": "Enforces secure TLS connections for SQL Server. Prevents use of deprecated TLS 1.0/1.1."
    },
    {
      "controlId": "8.1",
      "controlName": "No RDP from Internet",
      "category": "Network",
      "frameworks": ["CIS", "ASB"],
      "priority": "P0",
      "level": "L1",
      "severity": "Critical",
      "automated": true,
      "commercial": false,
      "propertyPath": "securityRules",
      "expectedValue": "No Allow rule for port 3389 from Internet/*",
      "checkLogic": "no rule where (access == 'Allow' AND direction == 'Inbound' AND destinationPortRange contains '3389' AND sourceAddressPrefix in ['*', 'Internet', '0.0.0.0/0'])",
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Network/networkSecurityGroups/{nsgName}/securityRules?api-version=2024-05-01",
      "cliCommand": "az network nsg rule list --nsg-name {nsgName} --resource-group {rg}",
      "remediationCommand": "az network nsg rule delete --nsg-name {nsgName} --resource-group {rg} --name {ruleName}",
      "businessImpact": "Prevents direct RDP access from internet, the #1 attack vector for Windows VMs. Use Azure Bastion or VPN for remote access.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/bastion/bastion-overview",
        "https://workbench.cisecurity.org/files/3459",
        "https://www.tenable.com/audits/items/CIS_Microsoft_Azure_Foundations_L1_v1.3.1.audit:[UPDATE_WITH_TENABLE_HASH_FOR_6.1]"
      ],
      "description": "Prevents direct RDP access from internet, the #1 attack vector for Windows VMs. Use Azure Bastion or VPN for remote access. This control is part of the CIS Microsoft Azure Foundations Benchmark."
    },
    {
      "controlId": "8.2",
      "controlName": "No SSH from Internet",
      "category": "Network",
      "frameworks": ["CIS", "ASB"],
      "priority": "P0",
      "level": "L1",
      "severity": "Critical",
      "automated": true,
      "commercial": false,
      "propertyPath": "securityRules",
      "expectedValue": "No Allow rule for port 22 from Internet/*",
      "checkLogic": "no rule where (access == 'Allow' AND direction == 'Inbound' AND destinationPortRange contains '22' AND sourceAddressPrefix in ['*', 'Internet', '0.0.0.0/0'])",
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Network/networkSecurityGroups/{nsgName}/securityRules?api-version=2024-05-01",
      "cliCommand": "az network nsg rule list --nsg-name {nsgName} --resource-group {rg}",
      "remediationCommand": "az network nsg rule delete --nsg-name {nsgName} --resource-group {rg} --name {ruleName}",
      "description": "Disable SSH access on network security groups from the Internet. The potential security problem with using SSH over the Internet is that attackers can use various brute force techniques to gain access to Azure Virtual Machines. Once the attackers gain access, they can use a virtual machine as a launch point for compromising other machines on the Azure Virtual Network or even attack networked devices outside of Azure.",
      "businessImpact": "Prevents direct SSH access from internet, the #1 attack vector for Linux VMs. Use Azure Bastion or VPN for remote access.",
      "references": [
        "https://www.tenable.com/audits/items/CIS_Microsoft_Azure_Foundations_L1_v1.3.1.audit:48bb413be641bc25e6ad2f5689a7dff1",
        "https://learn.microsoft.com/en-us/azure/bastion/bastion-overview",
        "https://workbench.cisecurity.org/files/3459"
      ]
    },
    {
      "controlId": "N/A",
      "controlName": "No Any-to-Any Allow Rules",
      "category": "Network",
      "frameworks": ["CIS"],
      "priority": "P0",
      "level": "L1",
      "severity": "High",
      "automated": true,
      "commercial": false,
      "propertyPath": "securityRules",
      "expectedValue": "No Allow rule with source * and destination *",
      "checkLogic": "no rule where (access == 'Allow' AND sourceAddressPrefix == '*' AND destinationAddressPrefix == '*')",
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Network/networkSecurityGroups/{nsgName}/securityRules?api-version=2024-05-01",
      "cliCommand": "az network nsg rule list --nsg-name {nsgName} --resource-group {rg}",
      "remediationCommand": "az network nsg rule delete --nsg-name {nsgName} --resource-group {rg} --name {ruleName}",
      "businessImpact": "Prevents overly permissive network rules that allow any source to reach any destination. Implements least-privilege network access.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview"
      ],
      "description": "Prevents overly permissive network rules that allow any source to reach any destination. Implements least-privilege network access."
    },
    {
      "controlId": "N/A",
      "controlName": "VPN Gateway - Availability Zone SKU Required",
      "category": "Network",
      "frameworks": ["ASB"],
      "priority": "P1",
      "level": "L1",
      "severity": "High",
      "automated": true,
      "commercial": false,
      "propertyPath": "properties.sku.name",
      "expectedValue": "VpnGw1AZ, VpnGw2AZ, VpnGw3AZ, VpnGw4AZ, VpnGw5AZ, or ExpressRoute SKU",
      "checkLogic": "value ends with 'AZ' or starts with 'ErGw'",
      "valueMapping": {
        "VpnGw1": "VpnGw1 (Deprecated - EOL Sep 2026)",
        "VpnGw2": "VpnGw2 (Deprecated - EOL Sep 2026)",
        "VpnGw3": "VpnGw3 (Deprecated - EOL Sep 2026)",
        "VpnGw4": "VpnGw4 (Deprecated - EOL Sep 2026)",
        "VpnGw5": "VpnGw5 (Deprecated - EOL Sep 2026)",
        "VpnGw1AZ": "VpnGw1AZ (Zone-redundant)",
        "VpnGw2AZ": "VpnGw2AZ (Zone-redundant)",
        "VpnGw3AZ": "VpnGw3AZ (Zone-redundant)",
        "VpnGw4AZ": "VpnGw4AZ (Zone-redundant)",
        "VpnGw5AZ": "VpnGw5AZ (Zone-redundant)"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Network/virtualNetworkGateways?api-version=2024-05-01",
      "cliCommand": "az network vnet-gateway show --name {name} --resource-group {rg} --query sku.name",
      "remediationCommand": "az network vnet-gateway update --name {name} --resource-group {rg} --sku {newSku}",
      "businessImpact": "Non-AZ VPN Gateway SKUs (VpnGw1-5) are deprecated. From January 1, 2025, new gateways cannot be created with these SKUs. Existing gateways will be automatically migrated to AZ versions (VpnGw1AZ-5AZ) between April 2025 and September 2026. Migrate proactively to maintain control and avoid service disruption. EOL tracking is handled via Microsoft's official EOL lists.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/vpn-gateway/gateway-sku-consolidation",
        "https://azure.microsoft.com/en-us/updates/action-required-upgrade-your-vpn-gateway-skus-to-zone-redundant-versions-by-30-september-2026/"
      ],
      "description": "Non-AZ VPN Gateway SKUs (VpnGw1-5) are deprecated in favor of zone-redundant AZ versions (VpnGw1AZ-5AZ). From January 1, 2025, new gateways cannot be created with non-AZ SKUs. Existing gateways will be automatically migrated between April 2025 and September 2026."
    },
    {
      "controlId": "6.6",
      "controlName": "Network Watcher Enabled",
      "category": "Network",
      "frameworks": ["CIS"],
      "priority": "P1",
      "level": "L1",
      "severity": "Medium",
      "automated": true,
      "commercial": false,
      "enabled": true,
      "propertyPath": "properties.provisioningState",
      "expectedValue": "Succeeded",
      "checkLogic": "value == 'Succeeded'",
      "valueMapping": {
        "Succeeded": "Network Watcher enabled",
        "null": "Network Watcher not enabled"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Network/networkWatchers?api-version=2024-05-01",
      "cliCommand": "az network watcher show --location {region}",
      "remediationCommand": "az network watcher configure --resource-group NetworkWatcherRG --locations {region}",
      "businessImpact": "Enables Network Watcher to monitor and diagnose network issues. Network Watcher should be enabled in all regions where virtual networks exist.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/network-watcher/network-watcher-monitoring-overview",
        "https://workbench.cisecurity.org/files/3459",
        "https://www.tenable.com/audits/items/CIS_Microsoft_Azure_Foundations_L1_v1.3.1.audit:[UPDATE_WITH_TENABLE_HASH_FOR_6.6]"
      ],
      "description": "Enables Network Watcher to monitor and diagnose network issues. Network Watcher should be enabled in all regions where virtual networks exist. This control is part of the CIS Microsoft Azure Foundations Benchmark."
    },
    {
      "controlId": "7.2",
      "controlName": "Managed Disks",
      "category": "VM",
      "frameworks": ["CIS", "ASB"],
      "priority": "P0",
      "level": "L1",
      "severity": "High",
      "automated": true,
      "commercial": false,
      "propertyPath": "storageProfile.osDisk.managedDisk",
      "expectedValue": "Object exists (not unmanaged VHD)",
      "checkLogic": "value != null",
      "valueMapping": {
        "exists": "Managed disk (Secure)",
        "null": "Unmanaged VHD (Legacy - not recommended)"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Compute/virtualMachines?api-version=2024-03-01",
      "cliCommand": "az vm show --name {vmName} --resource-group {rg} --query storageProfile.osDisk.managedDisk",
      "remediationCommand": "az vm convert --name {vmName} --resource-group {rg}",
      "businessImpact": "Managed disks provide better security, availability, and management capabilities. Unmanaged disks are legacy and not recommended.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/virtual-machines/managed-disks-overview",
        "https://workbench.cisecurity.org/files/3459",
        "https://www.tenable.com/audits/items/CIS_Microsoft_Azure_Foundations_L1_v1.3.1.audit:[UPDATE_WITH_TENABLE_HASH_FOR_7.2]"
      ],
      "description": "Managed disks provide better security, availability, and management capabilities. Unmanaged disks are legacy and not recommended. This control is part of the CIS Microsoft Azure Foundations Benchmark."
    },
    {
      "controlId": "BR-1",
      "controlName": "VM Backup Enabled",
      "category": "VM",
      "frameworks": ["ASB"],
      "priority": "P1",
      "level": "N/A",
      "severity": "High",
      "automated": true,
      "commercial": true,
      "commercialCost": "Depends on storage/size",
      "propertyPath": "resources",
      "expectedValue": "Recovery Services Vault protection enabled",
      "checkLogic": "VM is associated with a Recovery Services Vault",
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.RecoveryServices/vaults?api-version=2016-06-01",
      "cliCommand": "az backup protection check-vm --vm {vmName} --resource-group {rg}",
      "remediationCommand": "Enable Azure Backup for the VM via Azure Portal or CLI.",
      "businessImpact": "Ensures business continuity and recovery from ransomware or accidental deletion.",
      "description": "Azure Backup should be enabled for all production virtual machines.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/backup/backup-azure-vms-first-look-arm"
      ]
    },
    {
      "controlId": "N/A",
      "controlName": "Azure Monitor Agent (AMA) Installed",
      "category": "VM",
      "frameworks": ["CIS", "ASB"],
      "priority": "P0",
      "level": "L1",
      "severity": "High",
      "automated": true,
      "commercial": false,
      "propertyPath": "extensions",
      "expectedValue": "AzureMonitorWindowsAgent or AzureMonitorLinuxAgent installed",
      "checkLogic": "extension exists where name in ['AzureMonitorWindowsAgent', 'AzureMonitorLinuxAgent']",
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Compute/virtualMachines/{vmName}/extensions?api-version=2024-03-01",
      "cliCommand": "az vm extension list --vm-name {vmName} --resource-group {rg}",
      "remediationCommand": "az vm extension set --name AzureMonitorWindowsAgent --publisher Microsoft.Azure.Monitor --vm-name {vmName} --resource-group {rg}",
      "businessImpact": "Azure Monitor Agent is the current monitoring solution. Provides telemetry and monitoring capabilities.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/azure-monitor/agents/azure-monitor-agent-overview"
      ],
      "description": "Azure Monitor Agent is the current monitoring solution. Provides telemetry and monitoring capabilities."
    },
    {
      "controlId": "N/A",
      "controlName": "NO Legacy MMA/OMS Agent (RETIRED)",
      "category": "VM",
      "frameworks": ["CIS"],
      "priority": "P0",
      "level": "L1",
      "severity": "Critical",
      "automated": true,
      "commercial": false,
      "propertyPath": "extensions",
      "expectedValue": "MicrosoftMonitoringAgent or OmsAgentForLinux NOT present",
      "checkLogic": "no extension where name in ['MicrosoftMonitoringAgent', 'OmsAgentForLinux']",
      "valueMapping": {
        "present": "Legacy agent detected (RETIRED Aug 2024)",
        "absent": "No legacy agent (Compliant)"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Compute/virtualMachines/{vmName}/extensions?api-version=2024-03-01",
      "cliCommand": "az vm extension list --vm-name {vmName} --resource-group {rg}",
      "remediationCommand": "az vm extension delete --name MicrosoftMonitoringAgent --vm-name {vmName} --resource-group {rg} && az vm extension set --name AzureMonitorWindowsAgent --publisher Microsoft.Azure.Monitor --vm-name {vmName} --resource-group {rg}",
      "businessImpact": "Log Analytics Agent (MMA/OMS) was RETIRED August 31, 2024. Must migrate to Azure Monitor Agent immediately. EOL tracking is handled via Microsoft's official EOL lists.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/azure-monitor/agents/log-analytics-agent"
      ],
      "description": "Log Analytics Agent (MMA/OMS) was RETIRED August 31, 2024. Must migrate to Azure Monitor Agent immediately."
    },
    {
      "controlId": "9.3",
      "controlName": "App Service - Minimum TLS 1.2",
      "category": "AppService",
      "frameworks": ["CIS", "ASB"],
      "priority": "P0",
      "level": "L1",
      "severity": "Critical",
      "automated": true,
      "commercial": false,
      "propertyPath": "properties.siteConfig.minTlsVersion",
      "expectedValue": "1.2 or 1.3",
      "checkLogic": "value in ['1.2', '1.3']",
      "valueMapping": {
        "1.0": "TLS 1.0 (Insecure)",
        "1.1": "TLS 1.1 (Insecure)",
        "1.2": "TLS 1.2 (Secure)",
        "1.3": "TLS 1.3 (Secure)"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Web/sites/{name}/config/web?api-version=2024-04-01",
      "cliCommand": "az webapp config show --name {name} --resource-group {rg} --query minTlsVersion",
      "remediationCommand": "az webapp config set --name {name} --resource-group {rg} --min-tls-version 1.2",
      "businessImpact": "Enforces secure TLS connections for web applications. Prevents use of deprecated protocols. EOL tracking is handled via Microsoft's official EOL lists.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/app-service/configure-ssl-bindings#enforce-tls-versions",
        "https://workbench.cisecurity.org/files/3459",
        "https://www.tenable.com/audits/items/CIS_Microsoft_Azure_Foundations_L1_v1.3.1.audit:[UPDATE_WITH_TENABLE_HASH_FOR_9.3]"
      ],
      "description": "Enforces secure TLS connections for web applications. Prevents use of deprecated protocols. This control is part of the CIS Microsoft Azure Foundations Benchmark."
    },
    {
      "controlId": "9.2",
      "controlName": "App Service - HTTPS Only",
      "category": "AppService",
      "frameworks": ["CIS", "ASB"],
      "priority": "P0",
      "level": "L1",
      "severity": "High",
      "automated": true,
      "commercial": false,
      "propertyPath": "properties.httpsOnly",
      "expectedValue": "true",
      "checkLogic": "value == true",
      "valueMapping": {
        "true": "HTTPS only (Secure)",
        "false": "HTTP allowed (Insecure)"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Web/sites?api-version=2024-04-01",
      "cliCommand": "az webapp show --name {name} --resource-group {rg} --query httpsOnly",
      "remediationCommand": "az webapp update --name {name} --resource-group {rg} --set httpsOnly=true",
      "businessImpact": "Forces all traffic to use secure HTTPS connections. Redirects HTTP to HTTPS automatically.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/app-service/configure-ssl-bindings#enforce-https",
        "https://workbench.cisecurity.org/files/3459",
        "https://www.tenable.com/audits/items/CIS_Microsoft_Azure_Foundations_L1_v1.3.1.audit:[UPDATE_WITH_TENABLE_HASH_FOR_9.2]"
      ],
      "description": "Forces all traffic to use secure HTTPS connections. Redirects HTTP to HTTPS automatically. This control is part of the CIS Microsoft Azure Foundations Benchmark."
    },
    {
      "controlId": "9.10",
      "controlName": "App Service - FTP Disabled",
      "category": "AppService",
      "frameworks": ["CIS"],
      "priority": "P0",
      "level": "L1",
      "severity": "High",
      "automated": true,
      "commercial": false,
      "propertyPath": "properties.siteConfig.ftpsState",
      "expectedValue": "Disabled or FtpsOnly",
      "checkLogic": "value in ['Disabled', 'FtpsOnly']",
      "valueMapping": {
        "AllAllowed": "FTP and FTPS allowed (Insecure)",
        "FtpsOnly": "FTPS only (Acceptable)",
        "Disabled": "FTP disabled (Secure)"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Web/sites/{name}/config/web?api-version=2024-04-01",
      "cliCommand": "az webapp config show --name {name} --resource-group {rg} --query ftpsState",
      "remediationCommand": "az webapp config set --name {name} --resource-group {rg} --ftps-state Disabled",
      "businessImpact": "Prevents insecure FTP file transfers. Use FTPS or better alternatives like Azure DevOps, GitHub Actions, or Kudu.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/app-service/deploy-ftp",
        "https://workbench.cisecurity.org/files/3459",
        "https://www.tenable.com/audits/items/CIS_Microsoft_Azure_Foundations_L1_v1.3.1.audit:[UPDATE_WITH_TENABLE_HASH_FOR_9.10]"
      ],
      "description": "Prevents insecure FTP file transfers. Use FTPS or better alternatives like Azure DevOps, GitHub Actions, or Kudu. This control is part of the CIS Microsoft Azure Foundations Benchmark."
    },
    {
      "controlId": "N/A",
      "controlName": "App Service - Remote Debugging Disabled",
      "category": "AppService",
      "frameworks": ["CIS"],
      "priority": "P1",
      "level": "L1",
      "severity": "Medium",
      "automated": true,
      "commercial": false,
      "enabled": true,
      "propertyPath": "properties.siteConfig.remoteDebuggingEnabled",
      "expectedValue": "false",
      "checkLogic": "value == false",
      "valueMapping": {
        "true": "Remote debugging enabled (Insecure)",
        "false": "Remote debugging disabled (Secure)"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Web/sites/{name}/config/web?api-version=2024-04-01",
      "cliCommand": "az webapp config show --name {name} --resource-group {rg} --query remoteDebuggingEnabled",
      "remediationCommand": "az webapp config set --name {name} --resource-group {rg} --remote-debugging-enabled false",
      "businessImpact": "Disables remote debugging in production environments to reduce attack surface. Remote debugging should only be enabled in development/test environments.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/app-service/configure-common#configure-general-settings"
      ],
      "description": "Disables remote debugging in production environments to reduce attack surface. Remote debugging should only be enabled in development/test environments."
    },
    {
      "controlId": "N/A",
      "controlName": "Azure Firewall Threat Intel",
      "category": "Network",
      "frameworks": ["CIS"],
      "priority": "P1",
      "level": "L1",
      "severity": "Medium",
      "automated": true,
      "commercial": false,
      "enabled": true,
      "propertyPath": "properties.threatIntelMode",
      "expectedValue": "Alert or Deny",
      "checkLogic": "value in ['Alert', 'Deny']",
      "valueMapping": {
        "Off": "Threat Intel disabled",
        "Alert": "Threat Intel enabled (Alert mode)",
        "Deny": "Threat Intel enabled (Deny mode)"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Network/azureFirewalls/{firewallName}?api-version=2024-05-01",
      "cliCommand": "az network firewall policy show --name {policyName} --resource-group {rg} --query threatIntelMode",
      "remediationCommand": "az network firewall policy update --name {policyName} --resource-group {rg} --threat-intel-mode Alert",
      "businessImpact": "Enables Threat Intelligence mode on Azure Firewall to block or alert on malicious IP addresses and domains from Microsoft threat intelligence feeds.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/firewall/threat-intel"
      ],
      "description": "Enables Threat Intelligence mode on Azure Firewall to block or alert on malicious IP addresses and domains from Microsoft threat intelligence feeds."
    },
    {
      "controlId": "8.3",
      "controlName": "Network Security Groups Configured",
      "category": "Network",
      "frameworks": ["CIS"],
      "priority": "P1",
      "level": "L1",
      "severity": "Medium",
      "automated": false,
      "commercial": false,
      "propertyPath": "networkSecurityGroups",
      "expectedValue": "NSG configured",
      "checkLogic": "NSG exists and is associated",
      "valueMapping": {
        "configured": "NSG configured",
        "not_configured": "NSG not configured"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Network/networkSecurityGroups?api-version=2024-05-01",
      "cliCommand": "az network nsg list --query [].name",
      "remediationCommand": "az network nsg create --name {nsgName} --resource-group {rg} --location {location}",
      "businessImpact": "Ensures Network Security Groups are configured to control network traffic flow and enforce security policies.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview",
        "https://workbench.cisecurity.org/files/3459"
      ],
      "description": "Ensure Network Security Groups (NSGs) are configured for subnets and network interfaces to control network traffic flow. This control is part of the CIS Microsoft Azure Foundations Benchmark."
    },
    {
      "controlId": "8.4",
      "controlName": "Network Security Groups Rules Reviewed",
      "category": "Network",
      "frameworks": ["CIS"],
      "priority": "P1",
      "level": "L1",
      "severity": "Medium",
      "automated": false,
      "commercial": false,
      "propertyPath": "networkSecurityGroupRules",
      "expectedValue": "Rules reviewed and compliant",
      "checkLogic": "rules reviewed and no overly permissive rules",
      "valueMapping": {
        "compliant": "Rules reviewed and compliant",
        "needs_review": "Rules need review"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Network/networkSecurityGroups/{nsgName}/securityRules?api-version=2024-05-01",
      "cliCommand": "az network nsg rule list --nsg-name {nsgName} --resource-group {rg}",
      "remediationCommand": "Review and update NSG rules to follow least-privilege principles",
      "businessImpact": "Ensures NSG rules are reviewed regularly to prevent overly permissive access rules that could expose resources to unauthorized access.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview",
        "https://workbench.cisecurity.org/files/3459"
      ],
      "description": "Ensure Network Security Group rules are reviewed regularly to ensure they follow least-privilege principles and do not expose resources unnecessarily. This control is part of the CIS Microsoft Azure Foundations Benchmark."
    },
    {
      "controlId": "8.7",
      "controlName": "Network Security Groups Flow Logs Enabled",
      "category": "Network",
      "frameworks": ["CIS"],
      "priority": "P1",
      "level": "L1",
      "severity": "Medium",
      "automated": true,
      "commercial": false,
      "propertyPath": "properties.enabled",
      "expectedValue": "true",
      "checkLogic": "value == true",
      "valueMapping": {
        "true": "Flow logs enabled",
        "false": "Flow logs disabled"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/resourceGroups/{rg}/providers/Microsoft.Network/networkSecurityGroups/{nsgName}/flowLogs?api-version=2024-05-01",
      "cliCommand": "az network watcher flow-log show --nsg {nsgName} --resource-group {rg}",
      "remediationCommand": "az network watcher flow-log create --resource-group {rg} --nsg {nsgName} --storage-account {storageAccount} --enabled true",
      "businessImpact": "Enables NSG flow logs to monitor network traffic patterns, troubleshoot connectivity issues, and detect security anomalies.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/network-watcher/network-watcher-nsg-flow-logging-overview",
        "https://workbench.cisecurity.org/files/3459"
      ],
      "description": "Ensure Network Security Group flow logs are enabled to monitor network traffic and detect security anomalies. This control is part of the CIS Microsoft Azure Foundations Benchmark."
    },
    {
      "controlId": "4.1.4",
      "controlName": "Azure AD Admin Configured",
      "category": "SQL",
      "frameworks": ["CIS", "ASB"],
      "priority": "P0",
      "level": "L1",
      "severity": "High",
      "automated": true,
      "commercial": false,
      "propertyPath": "administrators",
      "expectedValue": "Azure AD admin configured",
      "checkLogic": "Azure AD admin exists",
      "valueMapping": {
        "configured": "Azure AD admin configured",
        "not_configured": "No Azure AD admin"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Sql/servers/{serverName}/administrators?api-version=2023-08-01",
      "cliCommand": "az sql server ad-admin list --resource-group {rg} --server {serverName}",
      "remediationCommand": "az sql server ad-admin create --resource-group {rg} --server {serverName} --display-name {adminName} --object-id {objectId}",
      "businessImpact": "Configure an Azure AD administrator for SQL server to enable Azure AD authentication and centralized identity management.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/azure-sql/database/authentication-aad-configure",
        "https://workbench.cisecurity.org/files/3459"
      ],
      "description": "Ensure that an Azure Active Directory administrator is configured for SQL Servers to enable Azure AD authentication."
    },
    {
      "controlId": "N/A",
      "controlName": "ARC Agent Version Current",
      "category": "ARC",
      "frameworks": ["CIS"],
      "priority": "P0",
      "level": "L1",
      "severity": "High",
      "automated": true,
      "commercial": false,
      "enabled": true,
      "propertyPath": "properties.agentVersion",
      "expectedValue": "Version within last 12 months",
      "checkLogic": "version is current (within last 12 months)",
      "valueMapping": {
        "current": "Agent version is current",
        "outdated": "Agent version is outdated"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.HybridCompute/machines?api-version=2024-07-10",
      "cliCommand": "az connectedmachine show --name {name} --resource-group {rg} --query properties.agentVersion",
      "remediationCommand": "az connectedmachine upgrade --name {name} --resource-group {rg}",
      "description": "Ensure Azure ARC agent is kept up to date. Outdated agents may have security vulnerabilities and compatibility issues. The agent should be updated to a version released within the last 12 months.",
      "businessImpact": "Update ARC agent to a version released within the last 12 months for security and compatibility.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/azure-arc/servers/manage-agent",
        "https://workbench.cisecurity.org/files/3459"
      ]
    },
    {
      "controlId": "N/A",
      "controlName": "ARC Connection Status",
      "category": "ARC",
      "frameworks": ["CIS"],
      "priority": "P0",
      "level": "L1",
      "severity": "High",
      "automated": true,
      "commercial": false,
      "enabled": true,
      "propertyPath": "properties.status",
      "expectedValue": "Connected",
      "checkLogic": "value == 'Connected'",
      "valueMapping": {
        "Connected": "Machine is connected",
        "Disconnected": "Machine is disconnected",
        "Expired": "Machine connection expired"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.HybridCompute/machines?api-version=2024-07-10",
      "cliCommand": "az connectedmachine show --name {name} --resource-group {rg} --query properties.status",
      "remediationCommand": "az connectedmachine show --name {name} --resource-group {rg}",
      "description": "Ensure Azure ARC machines maintain a connected status. Disconnected machines cannot be managed, monitored, or updated, creating security and operational risks.",
      "businessImpact": "Ensure ARC machine is connected. Check network connectivity and agent status.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/azure-arc/servers/troubleshoot-agent-onboard",
        "https://workbench.cisecurity.org/files/3459"
      ]
    },
    {
      "controlId": "N/A",
      "controlName": "ARC AMA Extension Installed",
      "category": "ARC",
      "frameworks": ["CIS"],
      "priority": "P1",
      "level": "L1",
      "severity": "Medium",
      "automated": true,
      "commercial": false,
      "enabled": true,
      "propertyPath": "extensions",
      "expectedValue": "AzureMonitorWindowsAgent or AzureMonitorLinuxAgent installed",
      "checkLogic": "extension exists where type in ['AzureMonitorWindowsAgent', 'AzureMonitorLinuxAgent']",
      "valueMapping": {
        "installed": "AMA extension installed",
        "not_installed": "AMA extension not installed"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/resourceGroups/{rg}/providers/Microsoft.HybridCompute/machines/{name}/extensions?api-version=2024-07-10",
      "cliCommand": "az connectedmachine extension list --machine-name {name} --resource-group {rg}",
      "remediationCommand": "az connectedmachine extension create --name AzureMonitorWindowsAgent --publisher Microsoft.Azure.Monitor --machine-name {name} --resource-group {rg}",
      "description": "Install Azure Monitor Agent (AMA) extension on ARC machines to enable monitoring and telemetry collection. This provides visibility into machine health, performance, and security events.",
      "businessImpact": "Install Azure Monitor Agent (AMA) extension on ARC machine for monitoring.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/azure-arc/servers/manage-vm-extensions",
        "https://learn.microsoft.com/en-us/azure/azure-monitor/agents/azure-monitor-agent-overview",
        "https://workbench.cisecurity.org/files/3459"
      ]
    },
    {
      "controlId": "N/A",
      "controlName": "ARC Automatic Upgrade Enabled",
      "category": "ARC",
      "frameworks": ["CIS"],
      "priority": "P1",
      "level": "L1",
      "severity": "Medium",
      "automated": true,
      "commercial": false,
      "enabled": true,
      "propertyPath": "properties.agentUpgrade.enableAutomaticUpgrade",
      "expectedValue": "true",
      "checkLogic": "value == true",
      "valueMapping": {
        "true": "Automatic upgrade enabled",
        "false": "Automatic upgrade disabled"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.HybridCompute/machines?api-version=2024-07-10",
      "cliCommand": "az connectedmachine show --name {name} --resource-group {rg} --query properties.agentUpgrade.enableAutomaticUpgrade",
      "remediationCommand": "az connectedmachine upgrade enable --name {name} --resource-group {rg}",
      "description": "Enable automatic upgrade for ARC agent to ensure it stays current with security updates and new features. Automatic upgrades reduce manual maintenance overhead and ensure timely security patches.",
      "businessImpact": "Enable automatic upgrade for ARC agent to ensure it stays current with security updates.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/azure-arc/servers/manage-agent#automatic-upgrade",
        "https://workbench.cisecurity.org/files/3459"
      ]
    },
    {
      "controlId": "5.4",
      "controlName": "Diagnostic Settings Enabled",
      "category": "Monitor",
      "frameworks": ["CIS", "ASB"],
      "priority": "P1",
      "level": "L1",
      "severity": "Medium",
      "automated": true,
      "commercial": false,
      "enabled": true,
      "propertyPath": "diagnosticSettings",
      "expectedValue": "Diagnostic settings configured",
      "checkLogic": "diagnosticSettings exists and is configured",
      "valueMapping": {
        "configured": "Diagnostic settings configured",
        "not_configured": "Diagnostic settings not configured"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Insights/diagnosticSettings?api-version=2021-05-01-preview",
      "cliCommand": "az monitor diagnostic-settings list --resource {resourceId}",
      "remediationCommand": "az monitor diagnostic-settings create --resource {resourceId} --name <setting-name> --workspace <log-analytics-workspace-id>",
      "description": "Enable diagnostic settings for Azure resources to collect logs and metrics for monitoring, troubleshooting, and compliance. Diagnostic settings send resource telemetry to Log Analytics workspaces, storage accounts, or Event Hubs for analysis and retention.",
      "businessImpact": "Enable diagnostic settings for the resource to collect logs and metrics for monitoring.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/azure-monitor/essentials/diagnostic-settings",
        "https://workbench.cisecurity.org/files/3459",
        "https://www.tenable.com/audits/items/CIS_Microsoft_Azure_Foundations_L1_v1.3.1.audit:[UPDATE_WITH_TENABLE_HASH_FOR_5.4]"
      ]
    },
    {
      "controlId": "N/A",
      "controlName": "DCR Associations",
      "category": "Monitor",
      "frameworks": ["CIS"],
      "priority": "P1",
      "level": "L1",
      "severity": "Medium",
      "automated": true,
      "commercial": false,
      "enabled": true,
      "propertyPath": "associations",
      "expectedValue": "At least one DCR association",
      "checkLogic": "associations count > 0",
      "valueMapping": {
        "has_associations": "DCR has associations",
        "no_associations": "DCR has no associations"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Insights/dataCollectionRules/{dcrName}/associations?api-version=2022-06-01",
      "cliCommand": "az monitor data-collection rule association list --rule-id {dcrId}",
      "remediationCommand": "az monitor data-collection rule association create --rule-id {dcrId} --resource <target-resource-id>",
      "description": "Associate Data Collection Rules (DCRs) with resources to enable centralized data collection for Azure Monitor. DCRs define what data to collect and where to send it, providing a modern approach to monitoring configuration.",
      "businessImpact": "Associate Data Collection Rule (DCR) with resources for centralized data collection.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/azure-monitor/agents/data-collection-rule-azure-monitor-agent",
        "https://workbench.cisecurity.org/files/3459"
      ]
    },
    {
      "controlId": "N/A",
      "controlName": "No MMA/OMS Agents",
      "category": "Monitor",
      "frameworks": ["CIS"],
      "priority": "P0",
      "level": "L1",
      "severity": "Critical",
      "automated": false,
      "commercial": false,
      "enabled": true,
      "propertyPath": "logAnalyticsWorkspace.heartbeat",
      "expectedValue": "No Direct Agent category in Heartbeat logs",
      "checkLogic": "no heartbeat records where Category == 'Direct Agent'",
      "valueMapping": {
        "no_legacy_agents": "No legacy MMA/OMS agents detected",
        "legacy_agents_present": "Legacy MMA/OMS agents detected (RETIRED Aug 2024)"
      },
      "apiEndpoint": "Query Log Analytics: Heartbeat | where Category == 'Direct Agent'",
      "cliCommand": "Query Log Analytics: Heartbeat | where Category == 'Direct Agent' | distinct Computer",
      "remediationCommand": "Migrate to Azure Monitor Agent: Remove MicrosoftMonitoringAgent/OmsAgentForLinux and install AzureMonitorWindowsAgent/AzureMonitorLinuxAgent",
      "description": "CRITICAL: Log Analytics Agent (Microsoft Monitoring Agent / OMS Agent) was RETIRED on August 31, 2024. No new installations are supported, and existing agents will stop receiving updates. All machines must migrate to Azure Monitor Agent (AMA) immediately. Legacy agents using 'Direct Agent' category in Heartbeat logs must be identified and replaced.",
      "businessImpact": "CRITICAL: Log Analytics Agent (MMA) was retired on August 31, 2024. Verify no machines are using Direct Agent category. Migrate to Azure Monitor Agent (AMA) immediately.",
      "eolDate": "2024-08-31",
      "eolStatus": "PAST",
      "references": [
        "https://learn.microsoft.com/en-us/azure/azure-monitor/agents/log-analytics-agent",
        "https://learn.microsoft.com/en-us/azure/azure-monitor/agents/azure-monitor-agent-migration",
        "https://workbench.cisecurity.org/files/3459"
      ]
    },
    {
      "controlId": "7.1.4",
      "controlName": "Log Analytics Workspace Retention Period",
      "category": "Monitor",
      "frameworks": ["CIS"],
      "priority": "P1",
      "level": "L1",
      "severity": "Medium",
      "automated": true,
      "commercial": false,
      "propertyPath": "properties.retentionInDays",
      "expectedValue": "90 days or more",
      "checkLogic": "value >= 90",
      "valueMapping": {
        "90+": "Retention period 90+ days",
        "<90": "Retention period less than 90 days"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.OperationalInsights/workspaces?api-version=2022-10-01",
      "cliCommand": "az monitor log-analytics workspace show --workspace-name {name} --resource-group {rg} --query retentionInDays",
      "remediationCommand": "az monitor log-analytics workspace update --workspace-name {name} --resource-group {rg} --retention-time 90",
      "businessImpact": "Ensures Log Analytics workspaces retain logs for at least 90 days to support security investigations and compliance requirements.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/azure-monitor/logs/data-retention-archive",
        "https://workbench.cisecurity.org/files/3459"
      ],
      "description": "Ensure Log Analytics workspace retention period is set to at least 90 days to support security investigations and compliance requirements. This control is part of the CIS Microsoft Azure Foundations Benchmark."
    },
    {
      "controlId": "9.3.5",
      "controlName": "Key Vault is Recoverable",
      "category": "KeyVault",
      "frameworks": ["CIS", "ASB"],
      "priority": "P0",
      "level": "L1",
      "severity": "Critical",
      "automated": true,
      "commercial": false,
      "propertyPath": "properties.enablePurgeProtection",
      "expectedValue": "true (both Soft Delete and Purge Protection enabled)",
      "checkLogic": "value == true",
      "valueMapping": {
        "true": "Recoverable (Soft Delete + Purge Protection Enabled)",
        "false": "Not Recoverable (Purge Protection Disabled)",
        "null": "Not Recoverable (Purge Protection Disabled)"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.KeyVault/vaults?api-version=2023-07-01",
      "cliCommand": "az keyvault show --name {name} --resource-group {rg} --query properties.enablePurgeProtection",
      "remediationCommand": "az keyvault update --name {name} --resource-group {rg} --enable-purge-protection true",
      "businessImpact": "Prevents permanent deletion of secret data before retention period expires. Enables recovery of deleted Key Vaults and objects. Essential for ransomware recovery. NOTE: Soft Delete will be mandatory from February 2025.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/key-vault/general/soft-delete-overview#purge-protection",
        "https://workbench.cisecurity.org/benchmarks/19304"
      ],
      "description": "Ensure that Key Vault is Recoverable by enabling both Soft Delete and Purge Protection. This prevents permanent deletion of keys/secrets/certificates and allows recovery of deleted vaults and objects. NOTE: Microsoft will enable soft-delete on all key vaults in February 2025, making it mandatory."
    },
    {
      "controlId": "8.3",
      "controlName": "Key Vault RBAC",
      "category": "KeyVault",
      "frameworks": ["CIS", "ASB"],
      "priority": "P1",
      "level": "L1",
      "severity": "Medium",
      "automated": true,
      "commercial": false,
      "propertyPath": "properties.enableRbacAuthorization",
      "expectedValue": "true",
      "checkLogic": "value == true",
      "valueMapping": {
        "true": "RBAC Authorization Enabled (Recommended)",
        "false": "Access Policies (Legacy)"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.KeyVault/vaults?api-version=2023-07-01",
      "cliCommand": "az keyvault show --name {name} --resource-group {rg} --query properties.enableRbacAuthorization",
      "remediationCommand": "az keyvault update --name {name} --resource-group {rg} --enable-rbac-authorization true",
      "businessImpact": "RBAC provides more granular access control and auditability than legacy Access Policies.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/key-vault/general/rbac-guide",
        "https://workbench.cisecurity.org/files/3459"
      ],
      "description": "Ensure that Azure RBAC is used for Key Vault authorization instead of Access Policies."
    },
    {
      "controlId": "8.1",
      "controlName": "Key Vault Firewall",
      "category": "KeyVault",
      "frameworks": ["CIS", "ASB"],
      "priority": "P0",
      "level": "L1",
      "severity": "High",
      "automated": true,
      "commercial": false,
      "propertyPath": "properties.networkAcls.defaultAction",
      "expectedValue": "Deny",
      "checkLogic": "value == 'Deny'",
      "valueMapping": {
        "Allow": "Allow All (Insecure)",
        "Deny": "Deny (Secure)"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.KeyVault/vaults?api-version=2023-07-01",
      "cliCommand": "az keyvault show --name {name} --resource-group {rg} --query properties.networkAcls.defaultAction",
      "remediationCommand": "az keyvault update --name {name} --resource-group {rg} --default-action Deny",
      "businessImpact": "Restricts network access to the Key Vault to specific IP addresses or virtual networks.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/key-vault/general/network-security",
        "https://workbench.cisecurity.org/files/3459"
      ],
      "description": "Ensure that the Key Vault firewall is enabled and configured to deny access by default."
    },
    {
      "controlId": "DP-4",
      "controlName": "VM Disk Encryption",
      "category": "VM",
      "frameworks": ["ASB"],
      "priority": "P1",
      "level": "N/A",
      "severity": "High",
      "automated": true,
      "commercial": false,
      "propertyPath": "storageProfile.osDisk.encryptionSettings",
      "expectedValue": "Azure Disk Encryption or Server-Side Encryption enabled",
      "checkLogic": "Disk encryption is enabled",
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Compute/virtualMachines?api-version=2024-03-01",
      "cliCommand": "az vm encryption show --name {vmName} --resource-group {rg}",
      "remediationCommand": "az vm encryption enable --name {vmName} --resource-group {rg} --disk-encryption-keyvault {keyVaultName}",
      "businessImpact": "Encrypts OS and data disks to protect data at rest. Azure Disk Encryption uses BitLocker (Windows) or DM-Crypt (Linux).",
      "description": "Enable encryption on virtual machine disks to protect data at rest. Azure provides multiple encryption options including Azure Disk Encryption and Server-Side Encryption.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/virtual-machines/disk-encryption-overview",
        "https://learn.microsoft.com/en-us/security/benchmark/azure/mcsb-data-protection#dp-4-enable-data-at-rest-encryption-by-default"
      ]
    },
    {
      "controlId": "NS-2",
      "controlName": "Storage Private Endpoints",
      "category": "Storage",
      "frameworks": ["ASB"],
      "priority": "P1",
      "level": "N/A",
      "severity": "Medium",
      "automated": true,
      "commercial": false,
      "propertyPath": "properties.privateEndpointConnections",
      "expectedValue": "At least one approved private endpoint connection",
      "checkLogic": "privateEndpointConnections exists and status == 'Approved'",
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Storage/storageAccounts?api-version=2024-01-01",
      "cliCommand": "az storage account show --name {name} --resource-group {rg} --query privateEndpointConnections",
      "remediationCommand": "az network private-endpoint create --name {peName} --resource-group {rg} --vnet-name {vnetName} --subnet {subnetName} --private-connection-resource-id {storageAccountId} --group-id blob --connection-name {connectionName}",
      "businessImpact": "Private endpoints enable secure connectivity from your virtual network to Azure Storage without exposing traffic to the public internet.",
      "description": "Use Azure Private Link to access Azure Storage securely over a private endpoint in your virtual network.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/storage/common/storage-private-endpoints",
        "https://learn.microsoft.com/en-us/security/benchmark/azure/mcsb-network-security#ns-2-secure-cloud-services-with-network-controls"
      ]
    },
    {
      "controlId": "DP-6",
      "controlName": "Key Vault Key Expiration",
      "category": "KeyVault",
      "frameworks": ["ASB"],
      "priority": "P1",
      "level": "N/A",
      "severity": "Medium",
      "automated": true,
      "commercial": false,
      "propertyPath": "attributes.expires",
      "expectedValue": "Expiration date set",
      "checkLogic": "Key has expiration date configured",
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/resourceGroups/{rg}/providers/Microsoft.KeyVault/vaults/{vaultName}/keys?api-version=2023-07-01",
      "cliCommand": "az keyvault key list --vault-name {vaultName} --query [].attributes.expires",
      "remediationCommand": "az keyvault key set-attributes --vault-name {vaultName} --name {keyName} --expires {expirationDate}",
      "businessImpact": "Setting expiration dates on cryptographic keys ensures regular key rotation and reduces risk of compromised keys being used indefinitely.",
      "description": "Ensure cryptographic keys in Key Vault have expiration dates set to enforce key rotation policies.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/key-vault/keys/about-keys",
        "https://learn.microsoft.com/en-us/security/benchmark/azure/mcsb-data-protection#dp-6-use-a-secure-key-management-process"
      ]
    },
    {
      "controlId": "9.3.1",
      "controlName": "Expiration Date Set for All Keys in RBAC Key Vaults",
      "category": "KeyVault",
      "frameworks": ["CIS"],
      "priority": "P1",
      "level": "L1",
      "severity": "Medium",
      "automated": true,
      "commercial": false,
      "propertyPath": "keys[].attributes.expires",
      "expectedValue": "All keys have expiration dates",
      "checkLogic": "all keys have expiration dates set",
      "valueMapping": {
        "all_set": "All keys have expiration dates",
        "some_missing": "Some keys missing expiration dates"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/resourceGroups/{rg}/providers/Microsoft.KeyVault/vaults/{vaultName}/keys?api-version=2023-07-01",
      "cliCommand": "az keyvault key list --vault-name {vaultName} --query [].attributes.expires",
      "remediationCommand": "az keyvault key set-attributes --vault-name {vaultName} --name {keyName} --expires {expirationDate}",
      "businessImpact": "Ensures all cryptographic keys in RBAC-enabled Key Vaults have expiration dates set to enforce key rotation policies.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/key-vault/keys/about-keys",
        "https://workbench.cisecurity.org/files/3459"
      ],
      "description": "Ensure all cryptographic keys in RBAC-enabled Key Vaults have expiration dates set. This control is part of the CIS Microsoft Azure Foundations Benchmark."
    },
    {
      "controlId": "9.3.2",
      "controlName": "Expiration Date Set for All Keys in Non-RBAC Key Vaults",
      "category": "KeyVault",
      "frameworks": ["CIS"],
      "priority": "P1",
      "level": "L1",
      "severity": "Medium",
      "automated": true,
      "commercial": false,
      "propertyPath": "keys[].attributes.expires",
      "expectedValue": "All keys have expiration dates",
      "checkLogic": "all keys have expiration dates set",
      "valueMapping": {
        "all_set": "All keys have expiration dates",
        "some_missing": "Some keys missing expiration dates"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/resourceGroups/{rg}/providers/Microsoft.KeyVault/vaults/{vaultName}/keys?api-version=2023-07-01",
      "cliCommand": "az keyvault key list --vault-name {vaultName} --query [].attributes.expires",
      "remediationCommand": "az keyvault key set-attributes --vault-name {vaultName} --name {keyName} --expires {expirationDate}",
      "businessImpact": "Ensures all cryptographic keys in non-RBAC Key Vaults have expiration dates set to enforce key rotation policies.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/key-vault/keys/about-keys",
        "https://workbench.cisecurity.org/files/3459"
      ],
      "description": "Ensure all cryptographic keys in non-RBAC Key Vaults have expiration dates set. This control is part of the CIS Microsoft Azure Foundations Benchmark."
    },
    {
      "controlId": "9.3.3",
      "controlName": "Expiration Date Set for All Secrets in RBAC Key Vaults",
      "category": "KeyVault",
      "frameworks": ["CIS"],
      "priority": "P1",
      "level": "L1",
      "severity": "Medium",
      "automated": true,
      "commercial": false,
      "propertyPath": "secrets[].attributes.expires",
      "expectedValue": "All secrets have expiration dates",
      "checkLogic": "all secrets have expiration dates set",
      "valueMapping": {
        "all_set": "All secrets have expiration dates",
        "some_missing": "Some secrets missing expiration dates"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/resourceGroups/{rg}/providers/Microsoft.KeyVault/vaults/{vaultName}/secrets?api-version=2023-07-01",
      "cliCommand": "az keyvault secret list --vault-name {vaultName} --query [].attributes.expires",
      "remediationCommand": "az keyvault secret set-attributes --vault-name {vaultName} --name {secretName} --expires {expirationDate}",
      "businessImpact": "Ensures all secrets in RBAC-enabled Key Vaults have expiration dates set to enforce secret rotation policies.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/key-vault/secrets/about-secrets",
        "https://workbench.cisecurity.org/files/3459"
      ],
      "description": "Ensure all secrets in RBAC-enabled Key Vaults have expiration dates set. This control is part of the CIS Microsoft Azure Foundations Benchmark."
    },
    {
      "controlId": "9.3.4",
      "controlName": "Expiration Date Set for All Secrets in Non-RBAC Key Vaults",
      "category": "KeyVault",
      "frameworks": ["CIS"],
      "priority": "P1",
      "level": "L1",
      "severity": "Medium",
      "automated": true,
      "commercial": false,
      "propertyPath": "secrets[].attributes.expires",
      "expectedValue": "All secrets have expiration dates",
      "checkLogic": "all secrets have expiration dates set",
      "valueMapping": {
        "all_set": "All secrets have expiration dates",
        "some_missing": "Some secrets missing expiration dates"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/resourceGroups/{rg}/providers/Microsoft.KeyVault/vaults/{vaultName}/secrets?api-version=2023-07-01",
      "cliCommand": "az keyvault secret list --vault-name {vaultName} --query [].attributes.expires",
      "remediationCommand": "az keyvault secret set-attributes --vault-name {vaultName} --name {secretName} --expires {expirationDate}",
      "businessImpact": "Ensures all secrets in non-RBAC Key Vaults have expiration dates set to enforce secret rotation policies.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/key-vault/secrets/about-secrets",
        "https://workbench.cisecurity.org/files/3459"
      ],
      "description": "Ensure all secrets in non-RBAC Key Vaults have expiration dates set. This control is part of the CIS Microsoft Azure Foundations Benchmark."
    },
    {
      "controlId": "LT-1",
      "controlName": "Enable Threat Detection",
      "category": "SQL",
      "frameworks": ["ASB"],
      "priority": "P1",
      "level": "N/A",
      "severity": "Medium",
      "automated": true,
      "commercial": true,
      "commercialCost": "Included with Defender for SQL ($15/server/month)",
      "propertyPath": "securityAlertPolicies/Default.state",
      "expectedValue": "Enabled",
      "checkLogic": "value == 'Enabled'",
      "valueMapping": {
        "Enabled": "Threat detection enabled",
        "Disabled": "Threat detection disabled"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Sql/servers/{serverName}/securityAlertPolicies/Default?api-version=2023-08-01",
      "cliCommand": "az sql server threat-policy show --resource-group {rg} --server {serverName}",
      "remediationCommand": "az sql server threat-policy update --resource-group {rg} --server {serverName} --state Enabled",
      "businessImpact": "Detects anomalous database activities indicating potential security threats such as SQL injection and brute force attacks.",
      "description": "Enable threat detection for Azure SQL to identify potential security threats and anomalous activities.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/azure-sql/database/threat-detection-configure",
        "https://learn.microsoft.com/en-us/security/benchmark/azure/mcsb-logging-threat-detection#lt-1-enable-threat-detection-capabilities"
      ]
    },
    {
      "controlId": "ES-1",
      "controlName": "Endpoint Detection and Response",
      "category": "VM",
      "frameworks": ["ASB"],
      "priority": "P1",
      "level": "N/A",
      "severity": "High",
      "automated": true,
      "commercial": true,
      "commercialCost": "Included with Defender for Servers (~$15/server/month)",
      "propertyPath": "extensions",
      "expectedValue": "MDE.Windows or MDE.Linux extension installed",
      "checkLogic": "extension exists where type contains 'MDE'",
      "valueMapping": {
        "installed": "Defender for Endpoint installed",
        "not_installed": "Defender for Endpoint not installed"
      },
      "apiEndpoint": "GET /subscriptions/{subscriptionId}/providers/Microsoft.Compute/virtualMachines/{vmName}/extensions?api-version=2024-03-01",
      "cliCommand": "az vm extension list --vm-name {vmName} --resource-group {rg}",
      "remediationCommand": "Enable Microsoft Defender for Servers in Defender for Cloud to auto-deploy MDE",
      "businessImpact": "Provides advanced threat detection, investigation, and response capabilities for virtual machines.",
      "description": "Deploy endpoint detection and response (EDR) capabilities via Microsoft Defender for Endpoint.",
      "references": [
        "https://learn.microsoft.com/en-us/azure/defender-for-cloud/integration-defender-for-endpoint",
        "https://learn.microsoft.com/en-us/security/benchmark/azure/mcsb-endpoint-security#es-1-use-endpoint-detection-and-response-edr"
      ]
    }
  ]
}
