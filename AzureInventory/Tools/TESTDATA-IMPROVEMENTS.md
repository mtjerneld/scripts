# Test Data Improvements Plan

## Problem
The test data generated by `New-TestData.ps1` differs structurally from real data collected by `Collect-CostData.ps1`, causing chart selection and filtering issues that don't appear with real data.

## Real Data Structure (from Collect-CostData.ps1)

### Top-Level Structure
```powershell
$result = @{
    GeneratedAt = Get-Date
    PeriodStart = $startDate
    PeriodEnd = $endDate
    DaysToInclude = $DaysToInclude
    TotalCostLocal = $totalCostLocal
    TotalCostUSD = $totalCostUSD
    Currency = $currency
    BySubscription = $bySubscription          # Keyed by SubscriptionId
    ByMeterCategory = $byMeterCategory        # Keyed by MeterCategory name
    TopResources = @(...)                     # Array of top 20 resources
    DailyTrend = @(...)                       # Array of daily entries (sorted by Date)
    RawData = $allCostData                    # Array of all raw cost records
    AllUniqueResourceNames = @(...)           # Array of unique resource names
    SubscriptionCount = $Subscriptions.Count
}
```

### BySubscription (Top-Level) - Keyed by SubscriptionId
```powershell
$bySubscription[$subId] = @{
    Name = $subName              # Display name
    SubscriptionId = $subId      # GUID
    CostLocal = $subCostLocal
    CostUSD = $subCostUSD
    Currency = $subCurrency
    ItemCount = $subItems.Count
}
```

### DailyTrend Entry
```powershell
$dailyTrend[$dateStr] = @{
    Date = [DateTime]
    DateString = "yyyy-MM-dd"
    TotalCostLocal = $dayCostLocal
    TotalCostUSD = $dayCostUSD
    ByCategory = @{...}           # Keyed by MeterCategory name
    BySubscription = @{...}       # Keyed by SubscriptionName (NOT SubscriptionId!)
    ByMeter = @{...}              # Keyed by Meter name
    ByResource = @{...}           # Keyed by ResourceName
}
```

### DailyTrend.ByCategory (Keyed by MeterCategory name)
```powershell
$dayByCategory[$cat] = @{
    CostLocal = $dayCatCostLocal
    CostUSD = $dayCatCostUSD
    BySubscription = @{
        $subName = @{
            CostLocal = ...
            CostUSD = ...
        }
    }
}
```

### DailyTrend.BySubscription (Keyed by SubscriptionName)
```powershell
$dayBySubscription[$subName] = @{
    CostLocal = $daySubCostLocal
    CostUSD = $daySubCostUSD
    ByCategory = @{
        $catName = @{
            CostLocal = ...
            CostUSD = ...
        }
    }
}
```

### DailyTrend.ByMeter (Keyed by Meter name)
```powershell
$dayByMeter[$meterName] = @{
    CostLocal = $dayMeterCostLocal
    CostUSD = $dayMeterCostUSD
    ByCategory = @{
        $catName = @{ CostLocal = ...; CostUSD = ... }
    }
    BySubscription = @{
        $subName = @{ CostLocal = ...; CostUSD = ... }
    }
}
```

### DailyTrend.ByResource (Keyed by ResourceName)
```powershell
$dayByResource[$resName] = @{
    CostLocal = $dayResCostLocal
    CostUSD = $dayResCostUSD
    ByCategory = @{
        $catName = @{ CostLocal = ...; CostUSD = ... }
    }
    BySubscription = @{
        $subName = @{ CostLocal = ...; CostUSD = ... }
    }
}
```

---

## Issues in Current Test Data (New-TestData.ps1)

### Issue 1: BySubscription Key Mismatch
**Real data:** Top-level BySubscription uses `SubscriptionId` as key
**Test data:** Uses subscription NAME as key

**Fix:** Change line 511-536 to use subscription IDs as keys:
```powershell
$bySubscription = @{
    'sub-prod-001' = @{          # Use ID, not name
        Name = 'Sub-Prod-001'
        SubscriptionId = 'sub-prod-001'
        ...
    }
}
```

### Issue 2: DailyTrend ByCategory.BySubscription Format
**Real data:** Each entry has `@{ CostLocal = ...; CostUSD = ... }`
**Test data:** Might be using direct numbers instead of objects

**Fix:** Verify all BySubscription entries in ByCategory use object format

### Issue 3: DailyTrend ByMeter Missing BySubscription
**Real data:** ByMeter includes BySubscription breakdown
**Test data:** May not include all breakdowns

**Fix:** Ensure ByMeter in DailyTrend has both ByCategory and BySubscription

### Issue 4: DailyTrend ByResource Missing BySubscription
**Real data:** ByResource includes BySubscription breakdown
**Test data:** May not include all breakdowns

**Fix:** Ensure ByResource in DailyTrend has both ByCategory and BySubscription

### Issue 5: Missing AllUniqueResourceNames
**Real data:** Has `AllUniqueResourceNames` array
**Test data:** May not include this

**Fix:** Add AllUniqueResourceNames to test data output

---

## Recommended Approach: Generate Test Data from Real Data Structure

The most reliable approach is to create a helper function that validates test data matches real data structure:

```powershell
function Test-CostDataStructure {
    param($CostData)

    $errors = @()

    # Check top-level keys
    $requiredKeys = @('GeneratedAt', 'PeriodStart', 'PeriodEnd', 'DaysToInclude',
                      'TotalCostLocal', 'TotalCostUSD', 'Currency', 'BySubscription',
                      'ByMeterCategory', 'TopResources', 'DailyTrend', 'RawData',
                      'SubscriptionCount')
    foreach ($key in $requiredKeys) {
        if (-not $CostData.ContainsKey($key)) {
            $errors += "Missing top-level key: $key"
        }
    }

    # Check BySubscription structure (should be keyed by ID)
    foreach ($subEntry in $CostData.BySubscription.GetEnumerator()) {
        $sub = $subEntry.Value
        if (-not $sub.Name) { $errors += "BySubscription[$($subEntry.Key)] missing Name" }
        if (-not $sub.SubscriptionId) { $errors += "BySubscription[$($subEntry.Key)] missing SubscriptionId" }
        if ($null -eq $sub.CostLocal) { $errors += "BySubscription[$($subEntry.Key)] missing CostLocal" }
    }

    # Check DailyTrend structure
    foreach ($day in $CostData.DailyTrend) {
        if (-not $day.DateString) { $errors += "DailyTrend entry missing DateString" }

        # Check ByCategory has BySubscription breakdown
        foreach ($catEntry in $day.ByCategory.GetEnumerator()) {
            $cat = $catEntry.Value
            if ($null -eq $cat.CostLocal) { $errors += "ByCategory[$($catEntry.Key)] missing CostLocal" }
            if (-not $cat.BySubscription) { $errors += "ByCategory[$($catEntry.Key)] missing BySubscription" }
            foreach ($subEntry in $cat.BySubscription.GetEnumerator()) {
                $subVal = $subEntry.Value
                if ($subVal -isnot [hashtable] -and $subVal -isnot [PSCustomObject]) {
                    $errors += "ByCategory[$($catEntry.Key)].BySubscription[$($subEntry.Key)] should be object, got $($subVal.GetType())"
                }
            }
        }

        # Check BySubscription has ByCategory breakdown
        foreach ($subEntry in $day.BySubscription.GetEnumerator()) {
            $sub = $subEntry.Value
            if ($null -eq $sub.CostLocal) { $errors += "BySubscription[$($subEntry.Key)] missing CostLocal" }
            if (-not $sub.ByCategory) { $errors += "BySubscription[$($subEntry.Key)] missing ByCategory" }
        }

        # Check ByMeter has both breakdowns
        foreach ($meterEntry in $day.ByMeter.GetEnumerator()) {
            $meter = $meterEntry.Value
            if (-not $meter.ByCategory) { $errors += "ByMeter[$($meterEntry.Key)] missing ByCategory" }
            if (-not $meter.BySubscription) { $errors += "ByMeter[$($meterEntry.Key)] missing BySubscription" }
        }

        # Check ByResource has both breakdowns
        foreach ($resEntry in $day.ByResource.GetEnumerator()) {
            $res = $resEntry.Value
            if (-not $res.ByCategory) { $errors += "ByResource[$($resEntry.Key)] missing ByCategory" }
            if (-not $res.BySubscription) { $errors += "ByResource[$($resEntry.Key)] missing BySubscription" }
        }
    }

    return $errors
}
```

---

## Quick Fix Summary

1. **Line 511-536**: Change BySubscription keys from names to IDs
2. **Lines 659-663**: Ensure BySubscription values are objects with CostLocal/CostUSD
3. **Lines 701-705**: Ensure ByMeter.BySubscription values are objects
4. **Lines 737-740**: Ensure ByResource.BySubscription values are objects
5. **Add AllUniqueResourceNames** to the output structure

After fixing, run the validation function to confirm structure matches.
