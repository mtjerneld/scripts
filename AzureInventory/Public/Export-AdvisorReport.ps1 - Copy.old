<#
.SYNOPSIS
    Generates an HTML report for Azure Advisor recommendations.

.DESCRIPTION
    Creates an interactive HTML report showing Azure Advisor recommendations
    grouped by category with filtering and search capabilities.

.PARAMETER AdvisorRecommendations
    Array of Advisor recommendation objects from Get-AzureAdvisorRecommendations.

.PARAMETER OutputPath
    Path for the HTML report output.

.PARAMETER TenantId
    Azure Tenant ID for display in report.

.OUTPUTS
    String path to the generated HTML report.
#>
function Export-AdvisorReport {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory = $true)]
        [AllowEmptyCollection()]
        [System.Collections.Generic.List[PSObject]]$AdvisorRecommendations,
        
        [Parameter(Mandatory = $true)]
        [string]$OutputPath,
        
        [string]$TenantId = "Unknown"
    )
    
    $timestamp = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
    
    # Calculate statistics
    $totalRecs = $AdvisorRecommendations.Count
    $byCategory = $AdvisorRecommendations | Group-Object Category
    $byImpact = $AdvisorRecommendations | Group-Object Impact
    
    # Group by category - handle both original Azure Advisor categories and mapped ones
    $costRecsRaw = @($AdvisorRecommendations | Where-Object { $_.Category -eq 'Cost' })
    $securityRecs = @($AdvisorRecommendations | Where-Object { $_.Category -eq 'Security' })
    $reliabilityRecs = @($AdvisorRecommendations | Where-Object { $_.Category -eq 'Reliability' -or $_.Category -eq 'HighAvailability' })
    $operationalRecs = @($AdvisorRecommendations | Where-Object { $_.Category -eq 'OperationalExcellence' })
    $performanceRecs = @($AdvisorRecommendations | Where-Object { $_.Category -eq 'Performance' })
    
    # Calculate potential savings - group duplicates first for Cost recommendations
    $groupedCostRecs = $costRecsRaw | Group-Object -Property @{
        Expression = {
            $typeId = if ($_.RecommendationType) { $_.RecommendationType } else { "Unknown" }
            $resId = if ($_.ResourceId) { $_.ResourceId } else { "Unknown" }
            "$typeId|$resId"
        }
    } | ForEach-Object {
        $group = $_.Group
        if ($group.Count -gt 1) {
            # Sum savings for duplicates
            $totalSavings = ($group | Where-Object { $_.PotentialSavings } | Measure-Object -Property PotentialSavings -Sum).Sum
            $currency = ($group | Where-Object { $_.SavingsCurrency } | Select-Object -First 1).SavingsCurrency
            if (-not $currency) { $currency = "USD" }
            
            $firstRec = $group[0]
            $firstRec.PotentialSavings = $totalSavings
            $firstRec.SavingsCurrency = $currency
            $firstRec
        } else {
            $group[0]
        }
    }
    
    # Use grouped Cost recommendations for display
    $costRecs = $groupedCostRecs
    
    $highImpact = @($AdvisorRecommendations | Where-Object { $_.Impact -eq 'High' }).Count
    $mediumImpact = @($AdvisorRecommendations | Where-Object { $_.Impact -eq 'Medium' }).Count
    $lowImpact = @($AdvisorRecommendations | Where-Object { $_.Impact -eq 'Low' }).Count
    
    $totalSavings = ($groupedCostRecs | Where-Object { $_.PotentialSavings } | Measure-Object -Property PotentialSavings -Sum).Sum
    if (-not $totalSavings) { $totalSavings = 0 }
    $savingsCurrency = ($groupedCostRecs | Where-Object { $_.SavingsCurrency } | Select-Object -First 1).SavingsCurrency
    if (-not $savingsCurrency) { $savingsCurrency = "USD" }
    
    $html = @"
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure Advisor Recommendations</title>
    <style>
        :root {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-surface: #252542;
            --bg-hover: #2d2d4a;
            --text-primary: #e8e8e8;
            --text-secondary: #b8b8b8;
            --text-muted: #888;
            --accent-green: #00d26a;
            --accent-red: #ff6b6b;
            --accent-yellow: #feca57;
            --accent-blue: #54a0ff;
            --accent-purple: #9b59b6;
            --accent-orange: #ff9f43;
            --border-color: #3d3d5c;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 0;
        }
        
        /* Navigation */
        .report-nav {
            background: var(--bg-secondary);
            padding: 15px 30px;
            display: flex;
            gap: 10px;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav-brand {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--accent-blue);
            margin-right: 30px;
        }
        
        .nav-link {
            color: var(--text-muted);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }
        
        .nav-link:hover {
            background: var(--bg-surface);
            color: var(--text-primary);
        }
        
        .nav-link.active {
            background: var(--accent-blue);
            color: white;
        }
        
        /* Main content */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px;
        }
        
        .page-header {
            margin-bottom: 30px;
        }
        
        .page-header h1 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .page-header .subtitle {
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        
        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: var(--bg-surface);
            padding: 24px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: transform 0.2s ease;
        }
        
        .summary-card:hover {
            transform: translateY(-2px);
        }
        
        .summary-card .value {
            font-size: 2.2rem;
            font-weight: 700;
            line-height: 1.2;
        }
        
        .summary-card .label {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .summary-card.total .value { color: var(--accent-blue); }
        .summary-card.cost .value { color: var(--accent-green); }
        .summary-card.security .value { color: var(--accent-red); }
        .summary-card.reliability .value { color: var(--accent-orange); }
        .summary-card.performance .value { color: var(--accent-purple); }
        .summary-card.savings .value { color: var(--accent-green); }
        
        /* Category sections */
        .category-section {
            background: var(--bg-surface);
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        
        .category-header {
            background: var(--bg-secondary);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .category-header:hover {
            background: var(--bg-hover);
        }
        
        .category-header.collapsed + .category-content {
            display: none;
        }
        
        .category-title {
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .category-icon {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }
        
        .category-icon.cost { background: rgba(0, 210, 106, 0.2); color: var(--accent-green); }
        .category-icon.security { background: rgba(255, 107, 107, 0.2); color: var(--accent-red); }
        .category-icon.reliability { background: rgba(255, 159, 67, 0.2); color: var(--accent-orange); }
        .category-icon.operational { background: rgba(84, 160, 255, 0.2); color: var(--accent-blue); }
        .category-icon.performance { background: rgba(155, 89, 182, 0.2); color: var(--accent-purple); }
        
        .category-stats {
            display: flex;
            gap: 15px;
            font-size: 0.85rem;
        }
        
        .category-stats .stat {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .category-content {
            padding: 0;
        }
        
        /* Table */
        .rec-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .rec-table th {
            background: var(--bg-hover);
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border-color);
        }
        
        .rec-table td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }
        
        .rec-table tr:last-child td {
            border-bottom: none;
        }
        
        .rec-table tr:hover td {
            background: var(--bg-hover);
        }
        
        .expandable-row {
            cursor: pointer;
        }
        
        .expandable-row.expanded .expand-icon-row {
            transform: rotate(90deg);
        }
        
        .expandable-row:hover {
            background: var(--bg-hover);
        }
        
        /* Impact badges */
        .impact-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .impact-badge.high {
            background: rgba(255, 107, 107, 0.15);
            color: var(--accent-red);
        }
        
        .impact-badge.medium {
            background: rgba(254, 202, 87, 0.15);
            color: var(--accent-yellow);
        }
        
        .impact-badge.low {
            background: rgba(84, 160, 255, 0.15);
            color: var(--accent-blue);
        }
        
        .savings-value {
            color: var(--accent-green);
            font-weight: 600;
        }
        
        .problem-text {
            color: var(--text-secondary);
            max-width: 400px;
        }
        
        .solution-text {
            color: var(--text-muted);
            font-size: 0.85rem;
            max-width: 400px;
        }
        
        .expand-cell {
            width: 20px;
            padding: 14px 8px !important;
        }
        
        .expand-icon-row {
            display: inline-block;
            width: 0;
            height: 0;
            border-left: 6px solid var(--text-muted);
            border-top: 5px solid transparent;
            border-bottom: 5px solid transparent;
            transition: transform 0.2s;
        }
        
        .rec-detail-row {
            background: var(--bg-hover);
        }
        
        .rec-detail-row td {
            border-top: none !important;
        }
        
        .detail-content {
            padding-left: 20px;
        }
        
        .detail-content a:hover {
            text-decoration: underline;
        }
        
        .detail-content pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .detail-content details summary {
            list-style: none;
            user-select: none;
        }
        
        .detail-content details summary::-webkit-details-marker {
            display: none;
        }
        
        .detail-content details summary::before {
            content: '\25B6';
            display: inline-block;
            margin-right: 8px;
            transition: transform 0.2s;
            color: var(--accent-blue);
            font-size: 0.7rem;
        }
        
        .detail-content details[open] summary::before {
            transform: rotate(90deg);
        }
        
        .expand-icon {
            width: 0;
            height: 0;
            border-left: 6px solid var(--text-muted);
            border-top: 5px solid transparent;
            border-bottom: 5px solid transparent;
            transition: transform 0.2s;
        }
        
        .category-header:not(.collapsed) .expand-icon {
            transform: rotate(90deg);
        }
        
        /* Filter section */
        .filter-section {
            background: var(--bg-surface);
            padding: 20px 24px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-group label {
            color: var(--text-muted);
            font-size: 0.85rem;
        }
        
        .filter-group select, .filter-group input {
            background: var(--bg-hover);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .filter-group input {
            width: 200px;
        }
        
        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }
        
        .no-data h2 {
            color: var(--accent-green);
            margin-bottom: 10px;
        }
        
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .summary-cards { grid-template-columns: repeat(2, 1fr); }
            .filter-section { flex-direction: column; align-items: stretch; }
            .category-stats { flex-wrap: wrap; gap: 10px; }
        }
    </style>
</head>
<body>
    <nav class="report-nav">
        <span class="nav-brand">Azure Audit Reports</span>
        <a href="index.html" class="nav-link">Dashboard</a>
        <a href="security.html" class="nav-link">Security Audit</a>
        <a href="vm-backup.html" class="nav-link">VM Backup</a>
        <a href="advisor.html" class="nav-link active">Advisor</a>
    </nav>
    
    <div class="container">
        <div class="page-header">
            <h1>Azure Advisor Recommendations</h1>
            <p class="subtitle">Generated: $timestamp | Tenant: $TenantId | $totalRecs recommendations</p>
        </div>
        
        <div class="summary-cards">
            <div class="summary-card total">
                <div class="value">$totalRecs</div>
                <div class="label">Total</div>
            </div>
            <div class="summary-card cost">
                <div class="value">$($costRecs.Count)</div>
                <div class="label">Cost</div>
            </div>
            <div class="summary-card security">
                <div class="value">$($securityRecs.Count)</div>
                <div class="label">Security</div>
            </div>
            <div class="summary-card reliability">
                <div class="value">$($reliabilityRecs.Count)</div>
                <div class="label">Reliability</div>
            </div>
            <div class="summary-card operational">
                <div class="value">$($operationalRecs.Count)</div>
                <div class="label">Operational</div>
            </div>
            <div class="summary-card performance">
                <div class="value">$($performanceRecs.Count)</div>
                <div class="label">Performance</div>
            </div>
            <div class="summary-card savings">
                <div class="value">$($savingsCurrency)$([math]::Round($totalSavings, 0))</div>
                <div class="label">Potential Savings/yr</div>
            </div>
        </div>
        
        <div class="filter-section">
            <div class="filter-group">
                <label for="searchFilter">Search:</label>
                <input type="text" id="searchFilter" placeholder="Resource, problem...">
            </div>
            <div class="filter-group">
                <label for="impactFilter">Impact:</label>
                <select id="impactFilter">
                    <option value="all">All</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="subscriptionFilter">Subscription:</label>
                <select id="subscriptionFilter">
                    <option value="all">All Subscriptions</option>
"@

    # Add subscription options
    $subscriptions = $AdvisorRecommendations | Select-Object -ExpandProperty SubscriptionName -Unique | Sort-Object
    foreach ($sub in $subscriptions) {
        $html += "                    <option value=`"$($sub.ToLower())`">$sub</option>`n"
    }
    
    $html += @"
                </select>
            </div>
        </div>
"@

    # Simple HTML escape function
    function Escape-Html {
        param([string]$text)
        if ([string]::IsNullOrEmpty($text)) { return "" }
        return $text -replace '&', '&amp;' -replace '<', '&lt;' -replace '>', '&gt;' -replace '"', '&quot;' -replace "'", '&#39;'
    }
    
    if ($totalRecs -eq 0) {
        $html += @"
        <div class="no-data">
            <h2>No Recommendations Found</h2>
            <p>Azure Advisor has no recommendations for your subscriptions. Great job!</p>
        </div>
"@
    }
    else {
        # Generate sections for each category
        $categories = @(
            @{ Name = "Cost"; Icon = "cost"; Recs = $costRecs; Label = "Cost Optimization" }
            @{ Name = "Security"; Icon = "security"; Recs = $securityRecs; Label = "Security" }
            @{ Name = "Reliability"; Icon = "reliability"; Recs = $reliabilityRecs; Label = "Reliability" }
            @{ Name = "OperationalExcellence"; Icon = "operational"; Recs = $operationalRecs; Label = "Operational Excellence" }
            @{ Name = "Performance"; Icon = "performance"; Recs = $performanceRecs; Label = "Performance" }
        )
        
        foreach ($cat in $categories) {
            if ($cat.Recs.Count -eq 0) { continue }
            
            # Group recommendations by RecommendationType (consolidated view)
            # This creates one row per recommendation type with expandable resource list
            $groupedByType = $cat.Recs | Group-Object -Property @{
                Expression = {
                    $typeId = if ($_.RecommendationType) { $_.RecommendationType } else { 
                        # Fallback: use Problem text as grouping key if RecommendationType is missing
                        $problemKey = if ($_.Problem) { $_.Problem.Substring(0, [Math]::Min(50, $_.Problem.Length)) } else { "Unknown" }
                        $problemKey
                    }
                    $typeId
                }
            }
            
            # Calculate category statistics from original recommendations (not grouped)
            $catHighCount = @($cat.Recs | Where-Object { $_.Impact -eq 'High' }).Count
            $catMediumCount = @($cat.Recs | Where-Object { $_.Impact -eq 'Medium' }).Count
            $catLowCount = @($cat.Recs | Where-Object { $_.Impact -eq 'Low' }).Count
            $catTotalResources = $cat.Recs.Count
            
            $html += @"
        
        <div class="category-section" data-category="$($cat.Name.ToLower())">
            <div class="category-header collapsed" onclick="toggleCategory(this)">
                <div class="category-title">
                    <span class="expand-icon"></span>
                    <span class="category-icon $($cat.Icon)">$($groupedByType.Count)</span>
                    <span>$($cat.Label)</span>
                </div>
                <div class="category-stats">
                    <span class="stat"><span class="impact-badge high">$catHighCount High</span></span>
                    <span class="stat"><span class="impact-badge medium">$catMediumCount Medium</span></span>
                    <span class="stat"><span class="impact-badge low">$catLowCount Low</span></span>
                    <span class="stat" style="margin-left: 10px; color: var(--text-muted);">($catTotalResources resources)</span>
                </div>
            </div>
            <div class="category-content">
                <table class="rec-table">
                    <thead>
                        <tr>
                            <th style="width: 20px;"></th>
                            <th>Recommendation</th>
                            <th>Impact</th>
                            <th>Affected Resources</th>
"@
            if ($cat.Name -eq "Cost") {
                $html += "                            <th>Total Potential Savings</th>`n"
            }
            $html += @"
                        </tr>
                    </thead>
                    <tbody>
"@
            
            # Sort groups by highest impact first, then by resource count
            $sortedGroups = $groupedByType | ForEach-Object {
                $group = $_.Group
                $highestImpact = "Low"
                if ($group | Where-Object { $_.Impact -eq 'Critical' }) { $highestImpact = "Critical" }
                elseif ($group | Where-Object { $_.Impact -eq 'High' }) { $highestImpact = "High" }
                elseif ($group | Where-Object { $_.Impact -eq 'Medium' }) { $highestImpact = "Medium" }
                
                [PSCustomObject]@{
                    Group = $group
                    Name = $_.Name
                    HighestImpact = $highestImpact
                    ResourceCount = $group.Count
                    ImpactOrder = switch ($highestImpact) { 'Critical' { 0 } 'High' { 1 } 'Medium' { 2 } 'Low' { 3 } default { 4 } }
                }
            } | Sort-Object ImpactOrder, @{Expression={-$_.ResourceCount}}
            
            foreach ($typeGroup in $sortedGroups) {
                $recsInGroup = $typeGroup.Group
                $firstRec = $recsInGroup[0]
                $recommendationType = $typeGroup.Name
                $resourceCount = $typeGroup.ResourceCount
                $highestImpact = $typeGroup.HighestImpact
                $impactClass = $highestImpact.ToLower()
                
                # Get recommendation title from first recommendation's Problem
                $recommendationTitle = if ($firstRec.Problem) { $firstRec.Problem } else { $recommendationType }
                
                # For Cost category, sum savings across all resources
                $totalSavings = $null
                $savingsCurrency = "USD"
                if ($cat.Name -eq "Cost") {
                    $savingsValues = $recsInGroup | Where-Object { $_.PotentialSavings } | Select-Object -ExpandProperty PotentialSavings
                    if ($savingsValues) {
                        $totalSavings = ($savingsValues | Measure-Object -Sum).Sum
                        $currencyRec = $recsInGroup | Where-Object { $_.SavingsCurrency } | Select-Object -First 1
                        if ($currencyRec) {
                            $savingsCurrency = $currencyRec.SavingsCurrency
                        }
                    }
                }
                
                # Escape HTML
                $escapedTitle = Escape-Html $recommendationTitle
                $escapedLongDescription = if ($firstRec.LongDescription) { Escape-Html $firstRec.LongDescription } else { "" }
                $escapedDescription = if ($firstRec.Description) { Escape-Html $firstRec.Description } else { "" }
                $escapedPotentialBenefits = if ($firstRec.PotentialBenefits) { Escape-Html $firstRec.PotentialBenefits } else { "" }
                $escapedLearnMoreLink = if ($firstRec.LearnMoreLink) { Escape-Html $firstRec.LearnMoreLink } else { "" }
                
                # Build searchable text
                $allResourceNames = ($recsInGroup | Select-Object -ExpandProperty ResourceName -Unique) -join " "
                $allSubscriptions = ($recsInGroup | Select-Object -ExpandProperty SubscriptionName -Unique) -join " "
                $searchable = "$recommendationTitle $allResourceNames $allSubscriptions".ToLower()
                
                $html += @"
                        <tr class="rec-type-row expandable-row" 
                            data-impact="$impactClass" 
                            data-searchable="$searchable"
                            onclick="toggleRowDetails(this)">
                            <td class="expand-cell">
                                <span class="expand-icon-row" style="display: inline-block; width: 12px; height: 12px; border-left: 4px solid var(--text-muted); border-top: 4px solid transparent; border-bottom: 4px solid transparent; transition: transform 0.2s;"></span>
                            </td>
                            <td>
                                <div class="recommendation-title" style="font-weight: 600; color: var(--text-primary);">$escapedTitle</div>
                            </td>
                            <td><span class="impact-badge $impactClass">$highestImpact</span></td>
                            <td>
                                <span style="font-weight: 500;">$resourceCount resource$(if ($resourceCount -ne 1) { 's' })</span>
                            </td>
"@
                if ($cat.Name -eq "Cost") {
                    $savingsDisplay = if ($totalSavings) { 
                        "$savingsCurrency$([math]::Round($totalSavings, 0))/yr" 
                    } else { 
                        "-" 
                    }
                    $html += "                            <td class=`"savings-value`" style=`"font-weight: 600; color: var(--accent-green);`">$savingsDisplay</td>`n"
                }
                $html += @"
                        </tr>
                        <tr class="rec-detail-row" style="display: none;">
                            <td></td>
                            <td colspan="$(if ($cat.Name -eq 'Cost') { 4 } else { 3 })" style="padding: 20px; background: var(--bg-hover);">
                                <div class="detail-content">
                                    <!-- Recommendation Details Section -->
                                    <div style="margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
                                        <h3 style="color: var(--accent-blue); margin-bottom: 12px; font-size: 1.1rem;">Recommendation details</h3>
                                        <div style="color: var(--text-secondary); line-height: 1.6;">
"@
                # Show LongDescription or Description
                if ($escapedLongDescription -and $escapedLongDescription -ne $escapedTitle) {
                    $html += "                                            $escapedLongDescription`n"
                } elseif ($escapedDescription -and $escapedDescription -ne $escapedTitle) {
                    $html += "                                            $escapedDescription`n"
                } else {
                    $html += "                                            $escapedTitle`n"
                }
                
                if ($escapedLearnMoreLink) {
                    $linkUri = Escape-Html $firstRec.LearnMoreLink
                    $arrowEntity = '&rarr;'
                    $lt = [char]60
                    $gt = [char]62
                    $spanStyle = 'font-size: 0.9rem;'
                    $spanTag = -join ($lt, 'span style=', [char]34, $spanStyle, [char]34, $gt)
                    $spanClose = -join ($lt, '/span', $gt)
                    $html += @"
                                            <div style="margin-top: 10px;">
                                                <a href="$linkUri" target="_blank" style="color: var(--accent-blue); text-decoration: none;">Learn more $spanTag$arrowEntity$spanClose</a>
                                            </div>
"@
                }
                $html += @"
                                        </div>
                                    </div>
"@
                
                # Potential Benefits (for Cost recommendations)
                if ($escapedPotentialBenefits -and $cat.Name -eq "Cost") {
                    $html += @"
                                    <div style="margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
                                        <h3 style="color: var(--accent-blue); margin-bottom: 12px; font-size: 1.1rem;">Potential benefits</h3>
                                        <div style="color: var(--text-secondary); line-height: 1.6;">$escapedPotentialBenefits</div>
                                    </div>
"@
                }
                
                # Affected Resources Table
                $html += @"
                                    <div style="margin-bottom: 25px;">
                                        <h3 style="color: var(--accent-blue); margin-bottom: 12px; font-size: 1.1rem;">Affected Resources ($resourceCount)</h3>
                                        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                                            <thead>
                                                <tr style="background: var(--bg-secondary); border-bottom: 2px solid var(--border-color);">
                                                    <th style="padding: 10px; text-align: left; font-weight: 600;">Subscription</th>
                                                    <th style="padding: 10px; text-align: left; font-weight: 600;">Resource Group</th>
                                                    <th style="padding: 10px; text-align: left; font-weight: 600;">Resource</th>
                                                    <th style="padding: 10px; text-align: left; font-weight: 600;">Impact</th>
"@
                if ($cat.Name -eq "Cost") {
                    $html += "                                                    <th style=`"padding: 10px; text-align: right; font-weight: 600;`">Potential Savings</th>`n"
                }
                $html += @"
                                                </tr>
                                            </thead>
                                            <tbody>
"@
                
                # Sort resources by impact, then by name
                $sortedResources = $recsInGroup | Sort-Object @{
                    Expression = { switch ($_.Impact) { 'Critical' { 0 } 'High' { 1 } 'Medium' { 2 } 'Low' { 3 } default { 4 } } }
                }, ResourceName
                
                foreach ($rec in $sortedResources) {
                    $recImpactClass = $rec.Impact.ToLower()
                    $recSavingsDisplay = if ($cat.Name -eq "Cost" -and $rec.PotentialSavings) {
                        "$($rec.SavingsCurrency)$([math]::Round($rec.PotentialSavings, 0))/yr"
                    } elseif ($cat.Name -eq "Cost") {
                        "-"
                    } else {
                        ""
                    }
                    
                    $html += @"
                                                <tr style="border-bottom: 1px solid var(--border-color);">
                                                    <td style="padding: 10px;">$(Escape-Html $rec.SubscriptionName)</td>
                                                    <td style="padding: 10px;">$(Escape-Html $rec.ResourceGroup)</td>
                                                    <td style="padding: 10px;"><strong>$(Escape-Html $rec.ResourceName)</strong></td>
                                                    <td style="padding: 10px;"><span class="impact-badge $recImpactClass">$($rec.Impact)</span></td>
"@
                    if ($cat.Name -eq "Cost") {
                        $html += "                                                    <td style=`"padding: 10px; text-align: right;`">$recSavingsDisplay</td>`n"
                    }
                    $html += @"
                                                </tr>
"@
                }
                
                $html += @"
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </td>
                        </tr>
"@
            }
            
            $html += @"
                    </tbody>
                </table>
            </div>
        </div>
"@
        }
    }
    
    # Add JavaScript - use placeholders to avoid PowerShell parsing issues
    $jsCode = @'
    </div>
    
    <script>
        function toggleCategory(header) {
            header.classList.toggle('collapsed');
        }
        
        function toggleRowDetails(row) {
            const detailRow = row.nextElementSibling;
            
            if (detailRow PLACEHOLDER_AND detailRow.classList.contains('rec-detail-row')) {
                const isExpanded = detailRow.style.display !== 'none';
                detailRow.style.display = isExpanded ? 'none' : 'table-row';
                row.classList.toggle('expanded', !isExpanded);
            }
        }
        
        // Filter functionality
        const searchFilter = document.getElementById('searchFilter');
        const impactFilter = document.getElementById('impactFilter');
        const subscriptionFilter = document.getElementById('subscriptionFilter');
        
        function applyFilters() {
            const searchText = searchFilter.value.toLowerCase();
            const impactValue = impactFilter.value;
            const subscriptionValue = subscriptionFilter.value;
            
            document.querySelectorAll('.category-section').forEach(section => {
                let visibleRows = 0;
                
                section.querySelectorAll('.rec-row').forEach(row => {
                    const searchable = row.getAttribute('data-searchable');
                    const impact = row.getAttribute('data-impact');
                    const subscription = row.getAttribute('data-subscription');
                    const detailRow = row.nextElementSibling;
                    
                    const searchMatch = searchText === '' || searchable.includes(searchText);
                    const impactMatch = impactValue === 'all' || impact === impactValue;
                    const subMatch = subscriptionValue === 'all' || subscription === subscriptionValue;
                    
                    if (searchMatch PLACEHOLDER_AND impactMatch PLACEHOLDER_AND subMatch) {
                        row.style.display = '';
                        // Hide detail row when filtering (user can expand again if needed)
                        if (detailRow PLACEHOLDER_AND detailRow.classList.contains('rec-detail-row')) {
                            detailRow.style.display = 'none';
                            row.classList.remove('expanded');
                        }
                        visibleRows++;
                    } else {
                        row.style.display = 'none';
                        // Hide associated detail row
                        if (detailRow PLACEHOLDER_AND detailRow.classList.contains('rec-detail-row')) {
                            detailRow.style.display = 'none';
                            row.classList.remove('expanded');
                        }
                    }
                });
                
                // Hide section if no visible rows
                section.style.display = visibleRows === 0 ? 'none' : '';
            });
        }
        
        searchFilter.addEventListener('input', applyFilters);
        impactFilter.addEventListener('change', applyFilters);
        subscriptionFilter.addEventListener('change', applyFilters);
    </script>
</body>
</html>
'@
    $jsCode = $jsCode -replace 'PLACEHOLDER_AND', '&&'
    $html += $jsCode
    
    # Write to file
    $html | Out-File -FilePath $OutputPath -Encoding UTF8
    
    return $OutputPath
}

